<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>천하제일 근성 대회 (World Grit Championship)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0; background:#0b1020; color:#fff;
      font-family: "Noto Sans KR", sans-serif;
      display:flex; flex-direction:column; align-items:center;
    }
    header {padding:10px; text-align:center;}
    main {display:flex; flex-wrap:wrap; justify-content:center; gap:20px; width:100%; max-width:1200px;}
    canvas {background:#000; border:2px solid #223066;}
    #leaderboard {flex:1; min-width:300px;}
    table {width:100%; border-collapse:collapse; color:#fff;}
    th, td {padding:6px; border-bottom:1px solid #223;}
    #statusBar {margin:10px; padding:8px; border-radius:6px; display:none;}
    #statusBar.ok {background:#153d2a; color:#4effa0;}
    #statusBar.danger {background:#402020; color:#ff7070;}
    /* 모바일 조작 버튼 */
    #controls {display:none; gap:10px; margin:15px;}
    #controls button {
      width:60px; height:60px; font-size:20px; font-weight:bold;
      border-radius:8px; border:none; background:#1a2a55; color:#fff;
    }
    @media(max-width:768px){
      #controls {display:flex; flex-wrap:wrap; justify-content:center;}
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h2>천하제일 근성 대회 (World Grit Championship)</h2>
    닉네임 <input id="nickname" value="Guest1234" />
    <button onclick="startGame()">게임 시작 / Start</button>
    <button onclick="restartGame()">재시작 / Restart</button>
    <span id="countryBadge">KR</span>
    <div id="statusBar"></div>
  </header>
  <main>
    <canvas id="game" width="300" height="600"></canvas>
    <div id="leaderboard">
      <h3>리더보드 / Leaderboard (Top 50)</h3>
      <table>
        <thead><tr><th>#</th><th>닉네임</th><th>국가</th><th>점수</th></tr></thead>
        <tbody id="lbBody"></tbody>
      </table>
    </div>
  </main>

  <!-- 모바일 전용 조작키 -->
  <div id="controls">
    <button onclick="moveLeft()">←</button>
    <button onclick="moveRight()">→</button>
    <button onclick="rotate()">⟳</button>
    <button onclick="softDrop()">↓</button>
    <button onclick="hardDrop()">⤓</button>
  </div>

<script>
/* ===========================
   Firebase 설정
=========================== */
const firebaseConfig = {
  apiKey: "발급받은_APIKEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "발급받은_SENDERID",
  appId: "발급받은_APPID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===========================
   국가 자동 감지
=========================== */
let USER_COUNTRY = "KR";
async function detectCountry(){
  try{
    const r = await fetch("https://YOUR-WORKER-NAME.workers.dev/", {mode:"cors"});
    if(!r.ok) throw new Error("bad status");
    const data = await r.json();
    if(data && data.country){
      USER_COUNTRY = data.country;
      document.getElementById("countryBadge").textContent = USER_COUNTRY;
    }
  }catch(e){
    console.warn("geo detect fail", e);
    USER_COUNTRY = "KR";
  }
}

/* ===========================
   상태 표시
=========================== */
function setStatus(msg, ok=true){
  const el=document.getElementById("statusBar");
  el.style.display="block";
  el.textContent=msg;
  el.className = ok? "ok":"danger";
}

/* ===========================
   점수 저장 / 리더보드
=========================== */
function submitScore(nick,score){
  const ref=db.ref("scores_v1").push();
  ref.set({
    nickname:nick,
    score:score,
    country:USER_COUNTRY,
    date: new Date().toISOString()
  });
}
function loadLeaderboard(){
  db.ref("scores_v1").orderByChild("score").limitToLast(50).on("value",snap=>{
    const arr=[];
    snap.forEach(c=>arr.push(c.val()));
    arr.sort((a,b)=>b.score-a.score);
    const body=document.getElementById("lbBody");
    body.innerHTML="";
    arr.forEach((v,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${v.nickname}</td><td>${v.country}</td><td>${v.score}</td>`;
      body.appendChild(tr);
    });
  });
}

/* ===========================
   간단한 게임 (테트리스 모형)
=========================== */
const cvs=document.getElementById("game");
const ctx=cvs.getContext("2d");
let score=0;
function drawBlock(x,y,color="#29f"){
  ctx.fillStyle=color;
  ctx.fillRect(x*30,y*30,30,30);
  ctx.strokeStyle="#000";
  ctx.strokeRect(x*30,y*30,30,30);
}
function gameOver(){
  const nick=document.getElementById("nickname").value||"Guest";
  submitScore(nick,score);
  setStatus("Game Over — 점수 업로드됨", true);
}
function startGame(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  score=Math.floor(Math.random()*5000); // 데모 점수
  drawBlock(4,0);
  setTimeout(gameOver,3000);
}
function restartGame(){startGame();}

/* ===========================
   모바일 조작키 함수
=========================== */
function moveLeft(){console.log("←");}
function moveRight(){console.log("→");}
function rotate(){console.log("⟳");}
function softDrop(){console.log("↓");}
function hardDrop(){console.log("⤓");}

/* 초기 실행 */
detectCountry();
setStatus("Firebase 연결 OK / Connected", true);
loadLeaderboard();
</script>
</body>
</html>
