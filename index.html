<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>천하제일 근성 대회</title>
<style>
:root{
  --bg:#0b1320;
  --panel:#0f1b2f;
  --line:#1c2a44;
  --text:#cfe6ff;
  --muted:#8ea7c7;
  --accent:#22c55e;
  --danger:#ef4444;
  --gold:#facc15;
  --blue:#60a5fa;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:#07101d radial-gradient(1000px 1000px at 20% -10%, #0d1930 0%, #07101d 60%) no-repeat;
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Apple SD Gothic Neo",Malgun Gothic,sans-serif;
}
/* 레이아웃 */
.container{
  max-width:1260px;
  margin:20px auto;
  padding:0 16px;
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:16px;
}
.badges{
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 16px 8px;
  max-width:1260px;
  margin:10px auto 0;
  color:#a5c7ff;
}
.badge{
  background:#0e1a2c;
  border:1px solid #1f355b;
  color:#cfe6ff;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  display:inline-flex; gap:8px; align-items:center;
}
.badge--ok{ background:#0c2a17; border-color:#1e7f4f; color:#cfffde; }
.badge--seg{ background:#102033; border-color:#26436b; }
/* 보드 카드 */
.card{
  background:var(--panel);
  border:1px solid #1b2a45;
  border-radius:18px;
  padding:14px;
}
.card h3{ margin:0 0 10px; font-size:15px; color:#9fc5ff; font-weight:600; }
/* 보드 캔버스 */
.board-wrap{
  border:1px solid #223457;
  border-radius:14px;
  padding:10px;
  background:linear-gradient(180deg,#0e192b 0%, #0c1626 100%);
  display:flex; justify-content:center; align-items:center;
  aspect-ratio: 10/20;
}
#board{ width:100%; height:auto; max-width:100%; image-rendering: pixelated; }
/* 하단 정보 */
.footer-stats{
  display:flex; justify-content:space-between; margin-top:10px;
  color:var(--muted); font-size:13px;
}
.footer-stats b{ color:#e6f1ff; }
/* 우측 랭킹 */
.filters{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.pill{
  background:#0e1a2c; border:1px solid #233a61; color:#cfe6ff;
  border-radius:999px; padding:5px 10px; font-size:12px;
}
.pill--on{ background:#0b2a1a; border-color:#1f8a56; color:#d9ffe9; }
.statusbar{
  background:#0b2a1a; color:#caffdd; border:1px solid #1c6f49;
  padding:8px 12px; border-radius:10px; font-size:13px; margin-bottom:10px;
}
/* 테이블 */
.table{
  width:100%; border-collapse:collapse; overflow:hidden;
  border:1px solid #1a2b49; border-radius:14px;
}
.table th,.table td{
  border-bottom:1px solid #12203a;
  padding:10px 12px; font-size:14px; color:#cfe6ff;
  white-space:nowrap;
}
.table thead th{ background:#0d182b; color:#9fc5ff; font-weight:600; }
.table tr:nth-child(even) td{ background:#0f1b2f; }
/* 모달 */
.modal{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(3,10,20,.55); backdrop-filter: blur(2px);
}
.modal.on{ display:grid; }
.modal .box{
  width:min(92vw,360px);
  background:#0c1728; border:1px solid #1b2d4a; border-radius:18px;
  padding:18px;
}
.modal h4{ margin:0 0 12px; color:#bfe0ff }
.modal .muted{ color:#8ea7c7; font-size:13px; margin-bottom:10px; }
.input{
  width:100%; background:#0e1a2c; color:#eaf5ff; border:1px solid #29416d;
  border-radius:10px; padding:10px 12px; outline:none; font-size:14px;
}
.btn{
  background:linear-gradient(180deg,#27ce73,#159f57);
  border:1px solid #117645; color:white; font-weight:700;
  padding:10px 14px; border-radius:12px; cursor:pointer; width:100%; margin-top:10px;
}
.btn:active{ transform: translateY(1px); }
/* 모바일 컨트롤 */
.touchpad{
  display:none;
  position:fixed; left:0; right:0; bottom:8px;
  padding:0 10px; gap:8px; justify-content:center; z-index:10;
}
.touchpad button{
  background:#0f1b2f; border:1px solid #1e345c; color:#cfe6ff;
  border-radius:12px; padding:12px 14px; font-size:15px; min-width:58px;
}
@media (max-width: 820px){
  .container{ grid-template-columns:1fr; }
  .touchpad{ display:flex; flex-wrap:wrap; }
}
</style>
</head>
<body>

<!-- 상단 상태 뱃지 -->
<div class="badges">
  <span class="badge">KR</span>
  <span class="badge badge--ok">Firebase 연결 OK / Connected — 점수 업로드 가능</span>
</div>

<div class="container">
  <!-- 좌측 보드 -->
  <div class="card">
    <div class="board-wrap">
      <canvas id="board" width="300" height="600"></canvas>
    </div>
    <div class="footer-stats">
      <div>점수 <b id="ui-score">0</b></div>
      <div>라인 <b id="ui-lines">0</b></div>
      <div>레벨 <b id="ui-level">1</b></div>
    </div>
    <div style="margin-top:8px;color:var(--muted);font-size:13px">
      조작: ← → 이동 · ↑ 회전 · ↓ 소프트드롭 · Space 하드드롭 (클래식)
    </div>
  </div>

  <!-- 우측 랭킹(디자인 그대로) -->
  <div class="card">
    <div class="filters">
      <span class="pill pill--on">ALL</span>
      <span class="pill">This Week</span>
      <span class="pill">This Month</span>
      <span class="pill">ALL</span>
      <span class="pill">KR</span>
    </div>
    <div class="statusbar" id="liveBar">실시간 업데이트(Firebase RTDB) — 랭킹 연동 전, 게임 정상 동작 확인용 레이아웃</div>
    <table class="table" id="rankTable">
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>닉네임 / Nickname</th>
          <th>국가 / Country</th>
          <th>점수 / Score</th>
        </tr>
      </thead>
      <tbody id="rankTbody"></tbody>
    </table>
  </div>
</div>

<!-- 모바일 터치 패드 -->
<div class="touchpad" id="touchpad">
  <button data-act="left">←</button>
  <button data-act="right">→</button>
  <button data-act="rot">↻</button>
  <button data-act="soft">↓</button>
  <button data-act="hard">⤓</button>
</div>

<!-- 시작/게임오버 모달 -->
<div class="modal on" id="modal">
  <div class="box">
    <h4 id="modalTitle">시작 / Restart</h4>
    <div class="muted">닉네임을 입력하고 시작하세요.</div>
    <input class="input" id="nickname" placeholder="닉네임 (2자 이상)" />
    <button class="btn" id="startBtn">시작</button>
  </div>
</div>

<script>
/* =========================
   디자인/게임 코드 (그대로)
========================= */
const COLORS = {
  I: "#93c5fd", J: "#60a5fa", L: "#fbbf24",
  O: "#fde047", S: "#34d399", T: "#c084fc", Z: "#f87171"
};
const ORDER = ["I","J","L","O","S","T","Z"];
const COLS = 10, ROWS = 20;
let board = [];
let nickname = "";
let animationId = null;
let score = 0, lines = 0, level = 1;
const LINE_POINTS = [0, 40, 100, 300, 1200];
const SOFT_DROP_POINTS = 1;
const HARD_DROP_POINTS = 2;
const LEVEL_MS = [Infinity, 800, 720, 630, 550, 470, 390, 320, 260, 200, 170, 150, 130, 110, 100, 90];
function fallDelayMs(){ return LEVEL_MS[Math.min(level, LEVEL_MS.length-1)]; }
function updateStatsUI(){
  document.getElementById('ui-score').textContent = score;
  document.getElementById('ui-lines').textContent = lines;
  document.getElementById('ui-level').textContent = level;
}
function maybeLevelUp(){ const newLv = Math.floor(lines/10)+1; if(newLv>level){ level = newLv; } }
const canvas = document.getElementById('board'); const ctx = canvas.getContext('2d'); let cellSize;
function resizeCanvas(){
  const wrap = canvas.parentElement.getBoundingClientRect();
  const w = Math.min(wrap.width, 520); const h = w * 2;
  canvas.width = w; canvas.height = h; cellSize = Math.floor(w/COLS); draw();
}
window.addEventListener('resize', resizeCanvas);
function drawGrid(){
  ctx.fillStyle = "#0c1627"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = "#1c2a44"; ctx.lineWidth = 1;
  for(let x=0;x<=COLS;x++){ ctx.beginPath(); ctx.moveTo(x*cellSize+.5,0); ctx.lineTo(x*cellSize+.5, canvas.height); ctx.stroke();}
  for(let y=0;y<=ROWS;y++){ ctx.beginPath(); ctx.moveTo(0,y*cellSize+.5); ctx.lineTo(canvas.width, y*cellSize+.5); ctx.stroke();}
}
function drawBlock(x,y,color){
  const px = x*cellSize, py = y*cellSize;
  ctx.fillStyle = color; ctx.fillRect(px+1, py+1, cellSize-2, cellSize-2);
  ctx.strokeStyle = "rgba(255,255,255,.08)"; ctx.strokeRect(px+1, py+1, cellSize-2, cellSize-2);
}
function draw(){
  drawGrid();
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){ const v = board[r][c]; if(v) drawBlock(c,r,v); }
  if(current){ current.shape.forEach((row,y)=>row.forEach((v,x)=>{ if(v) drawBlock(current.col+x,current.row+y,COLORS[current.type]); })); }
}
const SHAPES = {
  I: [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  J: [[1,0,0],[1,1,1],[0,0,0]],
  L: [[0,0,1],[1,1,1],[0,0,0]],
  O: [[1,1],[1,1]],
  S: [[0,1,1],[1,1,0],[0,0,0]],
  T: [[0,1,0],[1,1,1],[0,0,0]],
  Z: [[1,1,0],[0,1,1],[0,0,0]],
};
function rotate(shape){ const N=shape.length,ret=Array.from({length:N},()=>Array(N).fill(0)); for(let r=0;r<N;r++)for(let c=0;c<N;c++) ret[c][N-1-r]=shape[r][c]; return ret;}
let bag=[]; function refillBag(){ bag=[...ORDER].sort(()=>Math.random()-0.5); }
function nextType(){ if(bag.length===0) refillBag(); return bag.pop(); }
let current=null;
function spawnNextPiece(){
  const type=nextType(); const shape=SHAPES[type].map(row=>row.slice()); const col=Math.floor(COLS/2) - Math.ceil(shape[0].length/2); const row=0;
  current={type,shape,col,row}; if(!canPlace(0,0,shape)){ endGame(); }
}
function canPlace(dc,dr,shape=current.shape){
  const baseC=current.col+dc, baseR=current.row+dr;
  for(let y=0;y<shape.length;y++)for(let x=0;x<shape[y].length;x++){
    if(!shape[y][x]) continue; const nx=baseC+x, ny=baseR+y;
    if(nx<0||nx>=COLS||ny>=ROWS) return false;
    if(ny>=0 && board[ny][nx]) return false;
  }
  return true;
}
function move(dx,dy){ if(canPlace(dx,dy)){ current.col+=dx; current.row+=dy; draw(); return true;} return false; }
function tryRotate(){ const next=rotate(current.shape);
  if(canPlace(0,0,next)){ current.shape=next; draw(); return;}
  if(canPlace(-1,0,next)){ current.col--; current.shape=next; draw(); return;}
  if(canPlace(1,0,next)){ current.col++;  current.shape=next; draw(); return;}
}
function merge(){ const color=COLORS[current.type];
  current.shape.forEach((row,y)=>row.forEach((v,x)=>{ if(v){ const by=current.row+y, bx=current.col+x; if(by>=0) board[by][bx]=color; }}));
}
function clearLines(){
  let cleared=0;
  for(let r=ROWS-1;r>=0;r--){
    const full = board[r].every(cell => cell !== null);
    if(full){ board.splice(r,1); board.unshift(Array(COLS).fill(null)); cleared++; r++; }
  }
  if(cleared>0){ lines+=cleared; score+=LINE_POINTS[cleared]*level; maybeLevelUp(); updateStatsUI(); }
  return cleared;
}
function lockPiece(){ merge(); clearLines(); spawnNextPiece(); }
function softDrop(){ if(move(0,1)){ score+=SOFT_DROP_POINTS; updateStatsUI(); } else { lockPiece(); } }
function hardDrop(){ let d=0; while(move(0,1)) d++; if(d>0){ score+=d*HARD_DROP_POINTS; updateStatsUI(); } lockPiece(); }
let lastFall=0, running=false;
function loop(ts){ if(!running) return; if(!lastFall) lastFall=ts; const dt=ts-lastFall;
  if(dt>=fallDelayMs()){ if(!move(0,1)) lockPiece(); lastFall=ts; } draw(); animationId=requestAnimationFrame(loop);
}
function resetBoard(){ board=Array.from({length:ROWS},()=>Array(COLS).fill(null)); }
function resetGame(){ score=0; lines=0; level=1; updateStatsUI(); resetBoard(); refillBag(); spawnNextPiece(); draw(); }
function startGame(){ resetGame(); running=true; cancelAnimationFrame(animationId); lastFall=0; animationId=requestAnimationFrame(loop); }
function endGame(){ running=false; cancelAnimationFrame(animationId); showModal("Game Over"); }
document.addEventListener('keydown',(e)=>{
  if(!running) return;
  switch(e.code){
    case "ArrowLeft": e.preventDefault(); move(-1,0); break;
    case "ArrowRight": e.preventDefault(); move(1,0); break;
    case "ArrowUp": e.preventDefault(); tryRotate(); break;
    case "ArrowDown": e.preventDefault(); softDrop(); break;
    case "Space": e.preventDefault(); hardDrop(); break;
  }
});
document.getElementById('touchpad').addEventListener('click',(e)=>{
  const act=e.target.getAttribute('data-act'); if(!act||!running) return;
  if(act==="left") move(-1,0);
  if(act==="right") move(1,0);
  if(act==="rot") tryRotate();
  if(act==="soft") softDrop();
  if(act==="hard") hardDrop();
});
const modal=document.getElementById('modal'); const startBtn=document.getElementById('startBtn'); const modalTitle=document.getElementById('modalTitle');
function showModal(title){ modalTitle.textContent=title; modal.classList.add('on'); }
function hideModal(){ modal.classList.remove('on'); }
startBtn.addEventListener('click',()=>{
  const n=document.getElementById('nickname').value.trim();
  if(n.length<2){ alert("닉네임은 2자 이상 입력해 주세요."); return; }
  nickname=n; hideModal(); startGame();
});
resetBoard(); (function initSize(){ const ro=new ResizeObserver(()=>resizeCanvas()); ro.observe(document.querySelector('.board-wrap')); resizeCanvas(); })();
</script>

<!-- ▼▼▼ 여기부터: 저장/랭킹/필터 '추가' 스니펫(디자인/게임코드 변경 없음) ▼▼▼ -->
<script>
/* ===== Firebase 저장/조회 + 주/월/국가 필터 (추가 스니펫) ===== */
function loadScript(src){return new Promise(res=>{const s=document.createElement('script');s.src=src;s.onload=res;document.head.appendChild(s);});}

(function RankingBootstrap(){
  let rowsAll = [];             // 전체 랭킹 데이터
  let activeRange = 'all';      // 'all' | 'week' | 'month'
  let activeCountry = 'ALL';    // 'ALL' | 'KR'(확장 가능)
  const MAX_ROWS = 50;

  const $ = sel => document.querySelector(sel);
  const liveBarEl = $('#liveBar');
  const tbodyEl  = $('#rankTbody');

  function safeText(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function setLiveBar(t){ if(liveBarEl) liveBarEl.textContent = t; }

  function startOfWeek(ts){ const d=new Date(ts); const day=(d.getDay()+6)%7; d.setHours(0,0,0,0); d.setDate(d.getDate()-day); return d.getTime();}
  function startOfMonth(ts){ const d=new Date(ts); d.setHours(0,0,0,0); d.setDate(1); return d.getTime(); }

  function render(){
    if(!tbodyEl) return;
    const now=Date.now(), weekStart=startOfWeek(now), monthStart=startOfMonth(now);

    const filtered = rowsAll.filter(r=>{
      if(!r || typeof r.score!=='number') return false;
      if(activeRange==='week'  && !(r.ts>=weekStart))  return false;
      if(activeRange==='month' && !(r.ts>=monthStart)) return false;
      const cc=(r.country||'KR').toUpperCase();
      if(activeCountry!=='ALL' && cc!==activeCountry) return false;
      return true;
    });

    filtered.sort((a,b)=> b.score - a.score);
    const view = filtered.slice(0, MAX_ROWS);

    tbodyEl.innerHTML = view.map((r,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${safeText(r.nickname)}</td>
        <td>${safeText((r.country||'KR').toUpperCase())}</td>
        <td>${r.score}</td>
      </tr>
    `).join('');
  }

  // 버튼 텍스트 자동 매핑(마크업/디자인 변경 없음)
  function wireFilterButtons(){
    // 왼쪽 3개: ALL / This Week / This Month
    document.querySelectorAll('.filters .pill').forEach(el=>{
      const t=(el.textContent||'').trim().toLowerCase();
      if(t==='all'){ el.addEventListener('click',()=>{ activeRange='all';  render(); },{passive:true}); }
      if(t==='this week'){ el.addEventListener('click',()=>{ activeRange='week'; render(); },{passive:true}); }
      if(t==='this month'){ el.addEventListener('click',()=>{ activeRange='month'; render(); },{passive:true}); }
    });
    // 오른쪽 2개(동일 컨테이너 내): ALL / KR — 국가 필터
    // 같은 텍스트가 여러 개 있으므로 두 번째 그룹도 같이 매핑됩니다.
    document.querySelectorAll('.filters .pill').forEach(el=>{
      const t=(el.textContent||'').trim().toUpperCase();
      if(t==='ALL'){ el.addEventListener('click',()=>{ activeCountry='ALL'; render(); },{passive:true}); }
      if(t==='KR'){  el.addEventListener('click',()=>{ activeCountry='KR';  render(); },{passive:true}); }
    });
  }

  async function boot(){
    try{
      await loadScript('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js');

      // ⚠️ 본인 Firebase 구성으로 교체
      const firebaseConfig = {
  apiKey: "AIzaSyAHQngy1vRalgSIMOHEJvKcKkUGkUQWkPQ",
  authDomain: "grit-championship-v02.firebaseapp.com",
  databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
  projectId: "grit-championship-v02",
  storageBucket: "grit-championship-v02.firebasestorage.app",
  messagingSenderId: "644513888198",
  appId: "1:644513888198:web:baa0728174614bb68124c7",
  measurementId: "G-F8JGH16CR6"
};


      // 실시간 구독: /scores/YYYY-MM-DD/<nick>
      db.ref('scores').on('value', snap=>{
        const tmp=[];
        snap.forEach(dateSnap=>{
          dateSnap.forEach(userSnap=>{
            const v=userSnap.val();
            if(v && typeof v.score==='number'){ tmp.push(v); }
          });
        });
        rowsAll = tmp;
        render();
      });

      // 게임 오버 후 자동 저장 — 기존 endGame 유지(디자인/모달 그대로)
      const _endGame = window.endGame || function(){};
      window.endGame = function(){
        try{
          const nick = (document.getElementById('nickname').value || 'Guest').trim();
          const s = parseInt(document.getElementById('ui-score').textContent||'0',10) || 0;
          window.submitScoreToFirebase(nick, s, 'KR'); // 국가 기본 KR (워커 연동 시 교체 가능)
        }catch(e){ console.warn(e); }
        _endGame();
      };

      wireFilterButtons();
      setLiveBar('실시간 업데이트 (Firebase RTDB)');
    }catch(err){
      console.warn('Firebase boot error:', err);
      setLiveBar('랭킹 비활성 — Firebase 미연결');
    }
  }

  boot();
})();
</script>
<!-- ▲▲▲ 추가 스니펫 끝 (게임/디자인 변경 없음) ▲▲▲ -->

</body>
</html>

