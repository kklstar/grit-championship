<!-- Firebase 랭킹 통합 블록 (디자인/게임 로직 불변) -->
<script>
(function () {
  /* ====== 공용 로더 ====== */
  function loadScriptOnce(src) {
    return new Promise(function (resolve, reject) {
      if ([...document.scripts].some(s => s.src === src)) return resolve();
      const s = document.createElement('script');
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  /* ====== 날짜/키 유틸 ====== */
  function ymd(d = new Date()) {
    // UTC 기준으로 날짜 키 고정 (타임존 차이로 하루 어긋남 방지)
    return new Date(d.getTime() - d.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 10); // YYYY-MM-DD
  }
  function safeKey(str) {
    // RTDB 키 금지 문자 치환
    return String(str || 'Guest').replace(/[.#$/\[\]]/g, '_').trim().slice(0, 30) || 'Guest';
  }

  /* ====== Firebase 준비 + 초기화 ====== */
  async function ensureFirebaseReady() {
    // compat SDK (게임 코드 변경 없이 사용)
    await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
    await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js');

    /* ✅ 본인 프로젝트의 웹 앱 구성 값 유지/반영 */
    const firebaseConfig = {
      /* ↓↓↓ 여기에 'Firebase 콘솔 > 프로젝트 설정 > 웹 앱'의 값을 그대로 넣으세요 ↓↓↓ */
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "G-XXXXXXX"
      /* ↑↑↑ 그대로 유지/치환 ↑↑↑ */
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    return firebase.database();
  }

  /* ====== 부팅 ====== */
  async function boot() {
    const db = await ensureFirebaseReady();

    /* 연결 상태 간단 체크(배지용 로그) — UI는 건드리지 않음 */
    try {
      await db.ref('.info/connected').once('value');
      console.log('[RTDB] connected ✔');
    } catch (e) {
      console.warn('[RTDB] connect check failed', e);
    }

    /* ====== 랭킹 구독: 모든 날짜 → rowsAll에 적재 ======
       (렌더러는 기존 window.render()를 그대로 호출)
    */
    db.ref('scores').on('value', snap => {
      const list = [];
      snap.forEach(dateSnap => {
        dateSnap.forEach(userSnap => {
          const v = userSnap.val();
          if (v && typeof v.score === 'number') list.push(v);
        });
      });
      // 점수 내림차순 정렬 후 보관
      window.rowsAll = list.sort((a, b) => b.score - a.score);
      if (typeof window.render === 'function') window.render();
    });

    /* ====== 게임 종료 훅: 기존 endGame 보존 + 1회 저장 ======
       - 디자인/게임 로직은 그대로, 저장만 추가
       - 닉네임: #nickname, 점수: #ui-score, 국가: window.activeCountry or KR
    */
    const _endGame = window.endGame || function () {};
    window.endGame = function () {
      try {
        const nick = (document.getElementById('nickname')?.value || 'Guest').trim();
        const score = parseInt(document.getElementById('ui-score')?.textContent || '0', 10) || 0;
        const country = (window.activeCountry || document.getElementById('countryBtn')?.textContent || 'KR').trim();

        if (nick.length >= 2 && score > 0) {
          const dateKey = ymd();
          const nickKey = safeKey(nick);
          db.ref(`scores/${dateKey}/${nickKey}`).set({
            nickname: nick,
            score,
            country,
            date: new Date().toISOString()
          }).then(() => {
            console.log('[RTDB] score saved ✔', nick, score, country);
            // 필요 시 “점수 저장 완료/ Saved” 배지 업데이트는
            // 기존 UI 함수가 있으면 거기서 처리 (이 블록은 UI 변경 X)
          }).catch(console.warn);
        }
      } catch (e) {
        console.warn('[RTDB] save failed', e);
      }
      return _endGame.apply(this, arguments);
    };
  }

  // 실행
  boot().catch(console.warn);
})();
</script>
