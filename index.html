<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>천하제일 근성 대회</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f1630; --fg:#e7f0ff; --muted:#99a8c7; --line:#1b2548;
    --accent:#49b2ff; --gold:#ffd86b; --danger:#ff5666; --ok:#2ecc71;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  header{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  header h1{font-size:18px;margin:0 6px 0 0;letter-spacing:.2px}
  .flag{display:inline-flex;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-size:11px;padding:2px 8px}
  main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  @media(max-width:1000px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  .left{position:relative}
  .board{display:block;margin:0 auto;border-radius:10px;border:1px solid #223060;background:#09152c}
  .hud{display:flex;justify-content:space-between;margin-top:6px;font-size:14px;color:#9fb0d2}
  .ok{background:linear-gradient(180deg,#19c27a,#06a46a);border:0;color:#fff;border-radius:10px;padding:7px 10px;font-weight:700}
  .ghost{background:transparent;border:1px solid #3a4a7a;color:#cfe6ff;border-radius:10px;padding:6px 10px}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:7px 10px;border-bottom:1px solid var(--line);background:transparent;border-radius:10px;font-weight:600}
  .tab.active{background:#152a5a;color:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{font-size:14px;padding:10px;border-bottom:1px dashed rgba(255,255,255,.06);text-align:left}
  th{color:#9fb0d2}
  .notice{margin:8px 0 0 0;font-size:12px;color:#8aa0c8}
  .status{display:none;align-items:center;gap:8px;margin-bottom:8px;padding:6px 10px;border-radius:10px}
  .status.ok{display:flex;background:#0f2d1f;color:#b9ffd7;border:1px solid #1f6143}
  .status.save{display:flex;background:#1a2d17;color:#c8ffc2;border:1px solid #335f2b}
  footer{color:#7d8fb3;text-align:center;padding:16px 8px;border-top:1px solid var(--line)}
  /* overlay */
  .overlay{
    position:absolute;inset:0;background:linear-gradient(180deg,rgba(7,8,20,.75),rgba(7,8,20,.92));
    display:flex;align-items:center;justify-content:center;border-radius:12px
  }
  .overlay > .modal{
    width:85%;max-width:260px;background:rgba(13,18,42,.9);border:1px solid #24305a;border-radius:14px;padding:16px;text-align:center
  }
  .modal h3{margin:0 0 10px 0;font-size:16px}
  .modal input{
    width:100%;padding:10px;border-radius:10px;border:1px solid #2c3a6a;background:#0e1736;color:#fff
  }
  .modal .btn{width:100%;margin-top:10px}
  /* toasts */
  .toast{display:none;border-radius:10px;margin-bottom:8px;padding:6px 10px}
  .toast.ok{display:flex;background:#0f2d1f;color:#b9ffd7;border:1px solid #1f6143}
  .toast.warn{display:flex;background:#2b1518;color:#fedada;border:1px solid #7b303a}
</style>
</head>
<body>
<header>
  <h1>천하제일 근성 대회</h1>
  <span class="flag" id="countryFlag">KR</span>
  <span id="fbStatus" class="status">Firebase 연결 상태</span>
</header>

<main>
  <!-- LEFT: 게임 -->
  <section class="card left">
    <canvas id="board" class="board" width="300" height="540"></canvas>
    <div class="hud">
      <span>점수 <b id="sc">0</b></span>
      <span>라인 <b id="ln">0</b></span>
      <span>레벨 <b id="lv">1</b></span>
    </div>

    <!-- 닉네임/시작 & 재시작 오버레이 -->
    <div id="startOverlay" class="overlay">
      <div class="modal">
        <h3 id="overlayTitle">시작 / Restart</h3>
        <p class="notice">닉네임을 입력하고 시작하세요.</p>
        <input id="nickInput" placeholder="닉네임 / 2자 이상" minlength="2" maxlength="16" />
        <button id="startBtn" class="ok btn">시작</button>
        <p class="notice">조작키: ← → 이동 · ↑ 회전 · ↓ 소프트드롭 · Space 하드드롭</p>
      </div>
    </div>

    <!-- 토스트 -->
    <div id="saveToast" class="toast ok" style="position:absolute;left:12px;right:12px;bottom:12px">점수 저장 완료 / Saved</div>
    <div id="blockToast" class="toast warn" style="position:absolute;left:12px;right:12px;bottom:12px">접속이 제한되었습니다.</div>
  </section>

  <!-- RIGHT: 리더보드 -->
  <section class="card">
    <div class="tabs">
      <button class="tab active" id="tabAll">ALL</button>
      <button class="tab" id="tabWeek">This Week</button>
      <button class="tab" id="tabMonth">This Month</button>
      <span style="flex:1"></span>
      <button class="tab active" id="tabCountryAll">ALL</button>
      <button class="tab" id="tabCountryKR">KR</button>
    </div>

    <div id="rtToast" class="status ok">실시간 업데이트 (Firebase RTDB)</div>
    <div id="savedToast" class="status save">점수 저장 완료 / Saved</div>

    <table>
      <thead><tr><th style="width:60px">#</th><th>닉네임 / Nickname</th><th style="width:120px">국가 / Country</th><th style="width:120px">점수 / Score</th></tr></thead>
      <tbody id="rankBody"><tr><td colspan="4" class="notice">데이터 없음</td></tr></tbody>
    </table>

    <p class="notice">교육/프로토타입용 데모. 운영 전 서버 검증/보안 규칙 강화 필요.</p>
  </section>
</main>

<footer>© demo — Firebase RTDB + 클라이언트 테트리스</footer>

<!-- Firebase v10 compat (이미 사용중인 버전이면 그대로 유지) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ===== 환경설정 ===== */
const CONFIG = {
  COUNTRY_API: 'https://tetris.kklstar2.workers.dev/country', // Cloudflare Worker 엔드포인트 (아래 코드 참고)
  BLOCK_CN: true,        // 중국 차단 on/off
  USE_AUTOSAVE: true,    // 게임 종료 시 1회 자동 저장
  WEEK_OFFSET: 0,        // 0=이번주, -1=지난주
};

/* ===== Firebase 설정 (본인 값으로 유지) ===== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER",
  appId: "YOUR_APPID",
};
let app, db, RTDB_ENABLED = false;
try{
  app = firebase.initializeApp(firebaseConfig);
  db  = firebase.database();
  RTDB_ENABLED = true;
  setStatus('fbStatus','ok','Firebase 연결 OK / Connected — 점수 업로드 가능');
  document.getElementById('rtToast').style.display='flex';
}catch(e){
  setStatus('fbStatus','warn','Firebase 미설정 / 점수 업로드 OFF');
  console.warn(e);
}

/* ===== DOM ===== */
const cvs = document.getElementById('board'), ctx = cvs.getContext('2d');
const scEl = document.getElementById('sc'), lnEl = document.getElementById('ln'), lvEl = document.getElementById('lv');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const nickInput = document.getElementById('nickInput');
const overlayTitle = document.getElementById('overlayTitle');
const saveToast = document.getElementById('saveToast');
const savedToast = document.getElementById('savedToast');
const flagEl = document.getElementById('countryFlag');

/* ===== 국가 감지 & CN 차단 ===== */
let country = 'KR';
(async () => {
  try{
    const r = await fetch(CONFIG.COUNTRY_API, {cache:'no-store'});
    const j = await r.json();
    country = (j.country || 'KR').toUpperCase();
  }catch(e){ country = 'KR'; }
  flagEl.textContent = country;
  if(CONFIG.BLOCK_CN && country === 'CN'){
    // 게임 차단 (클라이언트 레벨)
    document.querySelector('.left').innerHTML = `
      <div class="overlay" style="position:relative;inset:auto;height:540px">
        <div class="modal"><h3>접속 제한</h3><p>중국 지역에서는 이용할 수 없습니다.</p></div>
      </div>`;
    document.getElementById('blockToast').style.display='block';
    throw new Error('blocked CN');
  }
})();

/* ===== 테트리스(아주 간단한 버전) ===== */
const COLS=10, ROWS=18, S=30;
cvs.width = COLS*S; cvs.height = ROWS*S+ (S*?0:0);
const SHAPES = {
  I:[[1,1,1,1]],
  J:[[2,0,0],[2,2,2]],
  L:[[0,0,3],[3,3,3]],
  O:[[4,4],[4,4]],
  S:[[0,5,5],[5,5,0]],
  T:[[0,6,0],[6,6,6]],
  Z:[[7,7,0],[0,7,7]],
};
const COLORS = ['#000','#69e2ff','#6aa6ff','#f7b26a','#ffd86b','#69ffa1','#947cff','#ff6aa1'];

let grid, cur, x, y, score, lines, level, running=false, dropT=null, savedThisRound=false;
let iGuarantee=12, iAppeared=0; // 12회 이내 I조각 보장

function reset(){
  grid = Array.from({length:ROWS},()=>Array(COLS).fill(0));
  score=0; lines=0; level=1; savedThisRound=false; iAppeared=0;
  scEl.textContent=score; lnEl.textContent=lines; lvEl.textContent=level;
  spawn(); draw();
}
function rndTet(){
  // 12회 안에 I가 반드시 나오도록 보정
  const keys = Object.keys(SHAPES);
  if(iAppeared >= iGuarantee-1){ iAppeared=0; return 'I'; }
  const k = keys[(Math.random()*keys.length)|0];
  if(k==='I'){ iAppeared=0; } else { iAppeared++; }
  return k;
}
function spawn(){
  const k=rndTet(); cur=SHAPES[k].map(r=>r.slice()); x=3; y=0;
}
function rotate(a){ // 시계
  const h=a.length,w=a[0].length; const r=Array.from({length:w},()=>Array(h).fill(0));
  for(let i=0;i<h;i++)for(let j=0;j<w;j++)r[j][h-1-i]=a[i][j]; return r;
}
function collide(nx=x,ny=y,nc=cur){
  for(let i=0;i<nc.length;i++)for(let j=0;j<nc[0].length;j++){
    if(!nc[i][j])continue;
    const yy=ny+i, xx=nx+j;
    if(xx<0||xx>=COLS||yy>=ROWS)return true;
    if(yy>=0&&grid[yy][xx])return true;
  }
  return false;
}
function merge(){
  for(let i=0;i<cur.length;i++)for(let j=0;j<cur[0].length;j++){
    if(cur[i][j] && y+i>=0) grid[y+i][x+j]=cur[i][j];
  }
  // 라인 클리어
  let gained=0;
  outer: for(let r=ROWS-1;r>=0;r--){
    for(let c=0;c<COLS;c++){ if(!grid[r][c]) continue outer; }
    grid.splice(r,1); grid.unshift(Array(COLS).fill(0));
    gained++; r++;
  }
  if(gained){
    lines += gained; lnEl.textContent=lines;
    const add = [0, 100, 300, 500, 800][gained] || (gained*200);
    score += add; scEl.textContent=score;
    level = 1 + Math.floor(lines/10); lvEl.textContent=level;
  }
}
function step(){
  if(!running) return;
  if(!collide(x,y+1)) y++;
  else{
    merge();
    if(y<=0){ // GAME OVER
      running=false; cancelAnimationFrame(dropT); dropT=null;
      drawGameOver(); onGameOver(); return;
    }
    spawn();
  }
  draw();
  const sp = Math.max(70, 700 - (level-1)*60);
  dropT = setTimeout(()=>requestAnimationFrame(step), sp);
}
function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  // 고정블록
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(grid[r][c]) fillCell(c,r, COLORS[grid[r][c]]);
  }
  // 현재블록
  for(let i=0;i<cur.length;i++)for(let j=0;j<cur[0].length;j++){
    if(cur[i][j]) fillCell(x+j,y+i, COLORS[cur[i][j]]);
  }
}
function drawGameOver(){
  draw();
  ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='#fff'; ctx.font='bold 30px ui-sans-serif'; ctx.textAlign='center';
  ctx.fillText('GAME OVER', cvs.width/2, cvs.height/2);
}
function fillCell(c,r,color){
  ctx.fillStyle=color; ctx.fillRect(c*S+1,r*S+1,S-2,S-2);
}

/* ===== 입력 ===== */
document.addEventListener('keydown',e=>{
  if(!running) return;
  if(e.code==='ArrowLeft' && !collide(x-1,y)) x--;
  else if(e.code==='ArrowRight' && !collide(x+1,y)) x++;
  else if(e.code==='ArrowUp'){
    const rot=rotate(cur); if(!collide(x,y,rot)) cur=rot;
  }
  else if(e.code==='ArrowDown' && !collide(x,y+1)) y++;
  else if(e.code==='Space'){
    while(!collide(x,y+1)) y++;
  }
  draw();
});

/* ===== 오버레이(시작/재시작) ===== */
function openOverlay(title='시작 / Restart'){
  overlayTitle.textContent = title;
  nickInput.value = (localStorage.getItem('nickname') || '').slice(0,16);
  startOverlay.style.display='flex';
  nickInput.focus();
}
function closeOverlay(){
  startOverlay.style.display='none';
}
startBtn.addEventListener('click',()=>{
  const nn = nickInput.value.trim();
  if(nn.length<2){ nickInput.focus(); return; }
  nickname = nn; localStorage.setItem('nickname', nickname);
  closeOverlay();
  startGame();
});

/* ===== 게임 루프/상태 ===== */
let nickname = localStorage.getItem('nickname') || '';
openOverlay(nickname? '재시작 / Restart' : '시작 / Restart');

function startGame(){
  reset();
  running=true;
  requestAnimationFrame(step);
}
function onGameOver(){
  // 1회 자동 저장(중복 방지 로직 내장)
  if(CONFIG.USE_AUTOSAVE) saveScoreOnce();
  // 재시작 팝업 (닉네임 함께)
  openOverlay('재시작 / Restart');
}

/* ===== 점수 저장 (중복 방지) ===== */
function todayKey(){ // YYYYMMDD
  const d = new Date(); const m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
  return `${d.getFullYear()}${m}${dd}`;
}
let savedHashThisRound = null;
async function saveScoreOnce(){
  if(!RTDB_ENABLED) return;
  const composite = `${(nickname||'Guest')}|${score}|${todayKey()}`;
  if(savedHashThisRound === composite) return; // 라운드 내 중복 방지
  try{
    // 서버측 중복 확인(닉네임+점수+일자)
    const snap = await db.ref('scores_v1').orderByChild('composite').equalTo(composite).limitToFirst(1).get();
    if(snap.exists()){
      // 이미 동일 기록이 있으면 저장 스킵
      console.log('duplicate skipped');
    }else{
      await db.ref('scores_v1').push({
        nickname: nickname || `Guest${(Math.random()*9000+1000|0)}`,
        country, score, ts: Date.now(), day: todayKey(), composite
      });
      savedHashThisRound = composite;
      showSaved();
    }
  }catch(e){ console.warn(e); }
}
function showSaved(){
  savedToast.style.display='flex';
  saveToast.style.display='block';
  setTimeout(()=>{ savedToast.style.display='none'; saveToast.style.display='none'; }, 1500);
}

/* ===== 리더보드 실시간 ===== */
const tbody = document.getElementById('rankBody');
let filterCountry = 'ALL';
let filterRange = 'ALL'; // ALL|WEEK|MONTH

function refresh(){
  if(!RTDB_ENABLED){ tbody.innerHTML='<tr><td colspan="4" class="notice">Firebase 미설정</td></tr>'; return; }
  // 범위 필터
  const now = Date.now();
  let since = 0;
  if(filterRange==='WEEK'){ const d=new Date(); const day=(d.getDay()+6)%7; d.setHours(0,0,0,0); since = d.getTime() - day*86400000; }
  if(filterRange==='MONTH'){ const d=new Date(); d.setDate(1); d.setHours(0,0,0,0); since = d.getTime(); }

  db.ref('scores_v1').orderByChild('score').limitToLast(200).on('value',snap=>{
    const out=[];
    snap.forEach(c=>{
      const v=c.val(); v.id=c.key;
      if(since && v.ts < since) return;
      if(filterCountry!=='ALL' && v.country!==filterCountry) return;
      out.push(v);
    });
    out.sort((a,b)=>b.score-a.score);
    tbody.innerHTML = out.slice(0,100).map((v,i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(v.nickname)}</td>
        <td>${v.country||'??'}</td>
        <td>${v.score}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="notice">No data</td></tr>`;
  });
}
function escapeHtml(s){return (''+s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

document.getElementById('tabAll').onclick =()=>{ setTab('tabAll'); filterRange='ALL';  refresh(); };
document.getElementById('tabWeek').onclick=()=>{ setTab('tabWeek');filterRange='WEEK'; refresh(); };
document.getElementById('tabMonth').onclick=()=>{setTab('tabMonth');filterRange='MONTH';refresh(); };
document.getElementById('tabCountryAll').onclick=()=>{ setTabCountry('tabCountryAll'); filterCountry='ALL'; refresh(); };
document.getElementById('tabCountryKR').onclick =()=>{ setTabCountry('tabCountryKR');  filterCountry='KR';  refresh(); };

function setTab(id){
  ['tabAll','tabWeek','tabMonth'].forEach(x=>document.getElementById(x).classList.toggle('active', x===id));
}
function setTabCountry(id){
  ['tabCountryAll','tabCountryKR'].forEach(x=>document.getElementById(x).classList.toggle('active', x===id));
}

// 최초 로딩
refresh();

/* ===== 유틸 ===== */
function setStatus(id, mode, text){
  const el=document.getElementById(id); if(!el) return;
  el.className='status ' + (mode==='ok'?'ok':'warn');
  el.textContent=text; el.style.display='flex';
}
</script>
</body>
</html>
