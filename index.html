<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>천하제일 근성 대회 (World Grit Championship)</title>
  <style>
    :root{--bg:#0e1020;--fg:#e9eefb;--panel:#14192a;--line:#22306e}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{font-size:18px;margin:0 6px 0 0}
    input,select,button{background:#0e1430;color:var(--fg);border:1px solid #1e2a55;border-radius:10px;padding:8px 10px;outline:none}
    button{cursor:pointer;font-weight:700}
    .wrap{display:grid;gap:16px;grid-template-columns:340px 1fr;padding:16px}
    .left{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    .board{display:flex;justify-content:center;margin-top:6px}
    canvas{background:#0a0f22;border:1px solid #22306e;border-radius:12px;display:block;margin:auto}
    .stat{display:flex;justify-content:space-between;margin:8px 0 0;font-size:13px;opacity:.9}
    .right{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
    th{text-align:left;opacity:.9}
    .ok{background:#0c2a18;border:1px solid #1a6b3b}
    .danger{background:#2a1212;border:1px solid #6b1a1a}
    #status{display:none;padding:8px 10px;border-radius:10px;margin:8px 0;font-size:13px}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.25);border-radius:12px}
    .overlay h2{margin:0 0 6px}
    .panel{position:relative}
    .help{font-size:12px;opacity:.75;line-height:1.5;margin-top:8px}
  </style>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1>천하제일 근성 대회</h1>
    <input id="nickname" placeholder="닉네임 / Nickname" value="Guest1234" />
    <button id="btnStart">게임 시작 / Start</button>
    <button id="btnRestart">재시작 / Restart</button>
    <span id="status"></span>
  </header>

  <main class="wrap">
    <section class="left panel">
      <div style="text-align:center;opacity:.6;margin:4px 0">AD — 여기에 배너/스크립트</div>
      <div class="board">
        <canvas id="game" width="240" height="480"></canvas>
        <div class="overlay" id="gameOver">
          <h2>GAME OVER</h2>
          <div>재시작 버튼으로 다시 도전!</div>
        </div>
      </div>
      <div class="stat">
        <div>점수 / Score <span id="sc">0</span></div>
        <div>라인 / Lines <span id="ln">0</span></div>
        <div>레벨 / Level <span id="lv">1</span></div>
      </div>
      <div class="help">
        조작: ← → 이동 | ↑ 회전 | ↓ 소프트드롭 | Space 하드드롭<br/>
        * 국가 표기는 데모에선 고정(KR). 운영 시 서버에서 IP→국가로 바꾸세요.
      </div>
    </section>

    <section class="right">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <strong>리더보드 / Leaderboard (Top 50)</strong>
      </div>
      <div id="status2" class="ok" style="display:none;padding:8px 10px;border-radius:10px;margin:6px 0;font-size:13px"></div>
      <table>
        <thead>
          <tr><th>#</th><th>닉네임 / Nickname</th><th>국가 / Country</th><th style="text-align:right">점수 / Score</th></tr>
        </thead>
        <tbody id="leader-tbody"></tbody>
      </table>
    </section>
  </main>

<script>
/* ==========================================================
   (1) Firebase 설정 — 본인 값으로 교체 (한 곳만 수정)
   ========================================================== */
const firebaseConfig = {
  apiKey: "여기에 본인 apiKey",
  authDomain: "grit-championship-v02.firebaseapp.com",
  databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
  projectId: "grit-championship-v02",
  storageBucket: "grit-championship-v02.appspot.com",
  messagingSenderId: "여기에 본인 messagingSenderId",
  appId: "여기에 본인 appId"
};

/* ==========================================================
   (2) 상태 표시 유틸
   ========================================================== */
let app, db;
let RTDB_ENABLED = !!(firebaseConfig && firebaseConfig.apiKey);
const $ = (s)=>document.querySelector(s);
function setStatus(msg, ok=false){
  const el = $("#status");
  if(!el){ console.log(msg); return; }
  el.textContent = msg;
  el.className = ok ? "ok" : "danger";
  el.style.display="inline-block";
}
try{
  app = firebase.initializeApp(firebaseConfig);
  db  = firebase.database();
  if(RTDB_ENABLED) setStatus("Firebase 연결 OK / Connected — 점수 업로드 가능", true);
}catch(e){
  RTDB_ENABLED = false;
  console.warn("Firebase init failed:", e);
  setStatus("Firebase 연결 실패 / Init failed", false);
}

/* ==========================================================
   (3) 점수 업로드 + 리더보드 구독
   ========================================================== */
async function submitScore(nickname, score, country="KR", durationMs=4000){
  if(!RTDB_ENABLED) return console.warn("RTDB disabled");
  if(durationMs<3000) return console.warn("Playtime too short (<3s)");
  const payload = {
    nickname: String(nickname||"Guest").slice(0,20),
    score: Math.max(0, Math.floor(score||0)),
    country: String(country||"KR").slice(0,3).toUpperCase(),
    date: new Date().toISOString(),
    ua: navigator.userAgent.slice(0,80)
  };
  console.log("Submitting score →", payload);
  try{
    const ref = await db.ref("scores_v1").push(payload);
    console.log("Score submitted ✔", ref.key);
    const s2 = $("#status2"); if(s2){ s2.style.display="block"; s2.textContent="점수 저장 완료 / Saved"; }
  }catch(err){
    console.error("Submit failed", err);
    const s2 = $("#status2"); if(s2){ s2.style.display="block"; s2.textContent="점수 저장 실패 / Failed"; s2.className="danger"; }
  }
}

function renderLeaderboard(rows){
  const tb = $("#leader-tbody"); if(!tb) return;
  tb.innerHTML = "";
  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:right;padding:6px">${i+1}</td>
      <td style="padding:6px">${r.nickname??"-"}</td>
      <td style="padding:6px">${r.country??"-"}</td>
      <td style="text-align:right;padding:6px">${r.score??0}</td>`;
    tb.appendChild(tr);
  });
  console.log("Leaderboard updated:", rows.length);
}

function startLeaderboard(){
  if(!RTDB_ENABLED) return;
  db.ref("scores_v1").orderByChild("score").limitToLast(50).on("value", snap=>{
    const arr=[]; snap.forEach(c=>arr.push(c.val()));
    arr.sort((a,b)=>(b.score||0)-(a.score||0));
    renderLeaderboard(arr);
  }, err=> console.error(err));
}
startLeaderboard();

/* ==========================================================
   (4) 초간단 테트리스 (필요 부분만) + 게임오버 연결
   ========================================================== */
const cvs = $("#game"), ctx = cvs.getContext("2d");
const W=10,H=20,S=24; // 보드 10x20, 셀 크기 24px
cvs.width = W*S; cvs.height = H*S;
const colors = ["#000","#36b24d","#5bc0de","#f0ad4e","#d9534f","#8e44ad","#3498db","#2ecc71"];

const SHAPES = {
  I:[[1,1,1,1]],
  O:[[2,2],[2,2]],
  T:[[0,3,0],[3,3,3]],
  S:[[0,4,4],[4,4,0]],
  Z:[[5,5,0],[0,5,5]],
  J:[[6,0,0],[6,6,6]],
  L:[[0,0,7],[7,7,7]]
};
function rndShape(){
  const keys = Object.keys(SHAPES);
  const k = keys[Math.floor(Math.random()*keys.length)];
  return SHAPES[k].map(r=>r.slice());
}
const board = Array.from({length:H},()=>Array(W).fill(0));
let cur = {m:rndShape(), x:3, y:0};
let score=0, lines=0, level=1, running=false, last=0, startMs=0;

function rotate(m){
  const h=m.length,w=m[0].length;
  const r=Array.from({length:w},()=>Array(h).fill(0));
  for(let y=0;y<h;y++) for(let x=0;x<w;x++) r[x][h-1-y]=m[y][x];
  return r;
}
function collide(nx,ny,m=cur.m){
  for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
    if(!m[y][x]) continue;
    const px=nx+x, py=ny+y;
    if(px<0||px>=W||py>=H) return true;
    if(py>=0 && board[py][px]) return true;
  } return false;
}
function merge(){
  cur.m.forEach((row,dy)=>{
    row.forEach((v,dx)=>{
      if(v && cur.y+dy>=0) board[cur.y+dy][cur.x+dx]=v;
    });
  });
}
function clearLines(){
  let cnt=0;
  for(let y=H-1;y>=0;y--){
    if(board[y].every(v=>v)){ board.splice(y,1); board.unshift(Array(W).fill(0)); cnt++; y++; }
  }
  if(cnt){
    score += [0,100,300,500,800][cnt];
    lines += cnt;
    level = 1 + Math.floor(lines/10);
  }
}
function spawn(){
  cur = {m:rndShape(), x:3, y:0};
  if(collide(cur.x,cur.y)) return false; // 스폰 충돌 → 게임오버
  return true;
}
function drawCell(x,y,v){
  ctx.fillStyle = v?colors[v]:"#0a0f22";
  ctx.fillRect(x*S,y*S,S-1,S-1);
}
function draw(){
  for(let y=0;y<H;y++)for(let x=0;x<W;x++) drawCell(x,y,board[y][x]);
  // 현재 조각
  cur.m.forEach((row,dy)=>row.forEach((v,dx)=>{
    if(v && cur.y+dy>=0) drawCell(cur.x+dx,cur.y+dy,v);
  }));
  $("#sc").textContent=score; $("#ln").textContent=lines; $("#lv").textContent=level;
}
function drop(){
  if(!running) return;
  if(!collide(cur.x,cur.y+1)){ cur.y++; }
  else{
    merge(); clearLines();
    if(!spawn()){ gameOver(); return; }
  }
}
function loop(t){
  if(!running) return;
  const speed = Math.max(60, 700 - level*50);
  if(t-last>speed){ drop(); last=t; }
  draw();
  requestAnimationFrame(loop);
}
function hardDrop(){
  while(!collide(cur.x,cur.y+1)) cur.y++;
  merge(); clearLines();
  if(!spawn()) { gameOver(); return; }
  draw();
}
function gameStart(){
  board.forEach(r=>r.fill(0)); spawn();
  score=0;lines=0;level=1; running=true; startMs=Date.now();
  $("#gameOver").style.display="none";
  requestAnimationFrame(loop);
}
function gameOver(){
  running=false;
  $("#gameOver").style.display="flex";
  const nick = $("#nickname")?.value || "Guest";
  const dur  = Date.now()-startMs;
  submitScore(nick, score, "KR", dur); // ← 업로드 연결
}

// controls
window.addEventListener("keydown",e=>{
  if(!running) return;
  if(e.code==="ArrowLeft" && !collide(cur.x-1,cur.y)) cur.x--;
  else if(e.code==="ArrowRight" && !collide(cur.x+1,cur.y)) cur.x++;
  else if(e.code==="ArrowDown" && !collide(cur.x,cur.y+1)) cur.y++;
  else if(e.code==="ArrowUp"){
    const r=rotate(cur.m); if(!collide(cur.x,cur.y,r)) cur.m=r;
  }else if(e.code==="Space"){ e.preventDefault(); hardDrop(); }
  draw();
});

// buttons
$("#btnStart").onclick = ()=>{ if(!running) gameStart(); };
$("#btnRestart").onclick= ()=>{ gameStart(); };
draw();
</script>
</body>
</html>
