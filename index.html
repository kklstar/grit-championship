<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>천하제일 근성 대회 (World Grit Championship)</title>
<style>
  :root{--bg:#0e1020;--fg:#e9eefb;--panel:#14192a;--line:#22306e}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0 8px 0 0;white-space:nowrap}
  .wrap{display:grid;gap:16px;grid-template-columns:360px 1fr;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .board{position:relative;display:flex;justify-content:center}
  canvas{background:#0a0f22;border:1px solid #22306e;border-radius:12px;display:block;width:100%;max-width:360px;height:auto;touch-action:none}
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.38);border-radius:12px;text-align:center;padding:16px}
  .overlay h2{margin:0 0 8px}
  .panel{background:#0e1430;border:1px solid #1e2a55;border-radius:14px;padding:14px;min-width:78%;max-width:90%}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
  input,button{background:#0e1430;color:var(--fg);border:1px solid #1e2a55;border-radius:10px;padding:10px 12px;outline:none}
  button{cursor:pointer;font-weight:700}
  button:disabled{opacity:.4;cursor:not-allowed}
  .ok{background:#0c2a18;border:1px solid #1a6b3b}
  .danger{background:#2a1212;border:1px solid #6b1a1a}
  #status{display:none;padding:6px 10px;border-radius:10px;margin-left:8px;font-size:13px}
  .seg{display:inline-flex;border:1px solid #1e2a55;border-radius:10px;overflow:hidden}
  .seg button{border:none;border-right:1px solid #1e2a55;background:#0e1430;padding:8px 12px}
  .seg button:last-child{border-right:none}
  .seg button.active{background:#15307e}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
  th{text-align:left;opacity:.9}
  .stat{display:flex;justify-content:space-between;margin-top:8px;font-size:13px;opacity:.95}

  /* 모바일 컨트롤러 */
  .controls{display:none;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .pad{display:flex;gap:10px}
  .ctl{width:64px;height:64px;border-radius:14px;background:#0e1430;border:1px solid #1e2a55;display:flex;align-items:center;justify-content:center;font-weight:800;user-select:none}
  .ctl:active{transform:translateY(1px);filter:brightness(1.1)}
  .wide{width:104px}
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
    .controls{display:flex}
  }
</style>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1>천하제일 근성 대회</h1>
    <span id="countryBadge" style="padding:6px 10px;border:1px solid #1e2a55;border-radius:10px;opacity:.85">KR</span>
    <span id="status"></span>
  </header>

  <main class="wrap">
    <!-- 좌측: 게임 -->
    <section class="card">
      <div style="text-align:center;opacity:.6;margin:4px 0">AD — 여기에 배너/스크립트</div>

      <div class="board">
        <canvas id="game" width="240" height="480"></canvas>

        <!-- 시작/재시작 오버레이 -->
        <div class="overlay start" id="startOverlay" style="display:flex">
          <div class="panel">
            <h2 id="ovTitle">게임 시작</h2>
            <div style="opacity:.8;margin-bottom:10px">닉네임을 입력하고 시작하세요.</div>
            <div class="row" style="margin-bottom:10px">
              <input id="nickname" placeholder="닉네임 / Nickname (2자 이상)" style="min-width:200px" />
              <button id="btnStart" disabled>시작</button>
            </div>
            <div style="font-size:12px;opacity:.7">조작키: ← → 이동 · ↑ 회전 · ↓ 소프트드롭 · Space 하드드롭</div>
          </div>
        </div>

        <!-- 게임오버 오버레이(문구만, 버튼은 위 오버레이 재사용) -->
        <div class="overlay" id="gameOver">
          <h2>GAME OVER</h2>
          <div>다시 하려면 <b>닉네임 입력</b> 후 <b>시작</b>을 누르세요</div>
        </div>
      </div>

      <div class="stat">
        <div>점수 / Score <span id="sc">0</span></div>
        <div>라인 / Lines <span id="ln">0</span></div>
        <div>레벨 / Level <span id="lv">1</span></div>
      </div>

      <!-- 모바일 터치 컨트롤러 -->
      <div class="controls" id="touchCtrls">
        <div class="pad">
          <div class="ctl" data-act="left">←</div>
          <div class="ctl" data-act="right">→</div>
        </div>
        <div class="pad">
          <div class="ctl" data-act="rotate">⟳</div>
          <div class="ctl" data-act="down">↓</div>
          <div class="ctl wide" data-act="drop">HARD</div>
        </div>
      </div>
    </section>

    <!-- 우측: 리더보드 -->
    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <strong>리더보드 / Leaderboard</strong>
        <div class="row" style="gap:8px">
          <!-- 기간 필터 -->
          <div class="seg" id="periodSeg">
            <button data-p="ALL" class="active">ALL</button>
            <button data-p="WEEK">This Week</button>
            <button data-p="MONTH">This Month</button>
          </div>
          <!-- 국가 필터 -->
          <div class="seg" id="countrySeg"></div>
        </div>
      </div>

      <div id="status2" class="ok" style="display:none;padding:8px 10px;border-radius:10px;margin:6px 0;font-size:13px"></div>
      <table>
        <thead>
          <tr><th>#</th><th>닉네임 / Nickname</th><th>국가 / Country</th><th style="text-align:right">점수 / Score</th></tr>
        </thead>
        <tbody id="leader-tbody"></tbody>
      </table>
    </section>
  </main>

<script>
/* 공용 도우미 */
const $ = sel => document.querySelector(sel);
function setStatus(msg, ok=false){
  const el = $("#status"); if(!el) return;
  el.textContent = msg; el.className = ok ? "ok" : "danger"; el.style.display="inline-block";
}

/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAHQng1yYRaIgSIMOHEJvKcKkUGjUQWkP0",
  authDomain: "grit-championship-v02.firebaseapp.com",
  databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
  projectId: "grit-championship-v02",
  storageBucket: "grit-championship-v02.firebasestorage.app",
  messagingSenderId: "644513888198",
  appId: "1:644513888198:web:baa0728174614bb68124c7",
  measurementId: "G-F8JGH16CR6"
};
let db=null, RTDB_ENABLED=false;
try{ firebase.initializeApp(firebaseConfig); db = firebase.database(); RTDB_ENABLED=!!db; setStatus("Firebase 연결 OK / Connected — 점수 업로드 가능", true);}
catch(e){ setStatus("Firebase 연결 실패 / Init failed", false); console.warn(e); }

/* ---------------- 국가코드(Cloudflare Worker) ---------------- */
let USER_COUNTRY = "KR";
async function detectCountry(){
  const WORKER_URL = "https://tetris.kklstar2.workers.dev/";
  try{
    const r = await fetch(WORKER_URL, {mode:"cors"}); const j = await r.json();
    if(j && j.country) USER_COUNTRY = String(j.country).toUpperCase();
  }catch(e){ USER_COUNTRY="KR"; }
  $("#countryBadge").textContent = USER_COUNTRY;
}

/* ---------------- (요청) Guest4701 자동 삭제 — 1회만 ---------------- */
async function purgeGuestOnce(){
  if(!RTDB_ENABLED) return;
  const flagKey = "purged_Guest4701_v1";
  if(localStorage.getItem(flagKey)) return;
  try{
    const snap = await db.ref("scores_v1").orderByChild("nickname").equalTo("Guest4701").once("value");
    if(snap.exists()){ snap.forEach(c => db.ref("scores_v1/"+c.key).remove()); }
    localStorage.setItem(flagKey, "1");
  }catch(e){ console.warn("Purge failed:", e); }
}

/* ---------------- 점수 업로드 ---------------- */
async function submitScore(nickname, score, country="KR", durationMs=0){
  if(!RTDB_ENABLED) return;
  if(!score || score<=0) return;
  const payload = {
    nickname: String(nickname||"Guest").trim().slice(0,20),
    score: Math.floor(score),
    country: String(country||"KR").trim().slice(0,3).toUpperCase(),
    date: new Date().toISOString()
  };
  try{
    await db.ref("scores_v1").push(payload);
    const s=$("#status2"); if(s){s.style.display="block"; s.textContent="점수 저장 완료 / Saved"; s.className="ok";}
  }catch(err){
    const s=$("#status2"); if(s){s.style.display="block"; s.textContent="점수 저장 실패 / Failed"; s.className="danger";}
  }
}

/* ---------------- 리더보드(기간/국가) ---------------- */
let currentRef=null, currentPeriod="ALL", currentCountry="ALL";
let latestRows = [];

function getPeriodStartISO(period){
  const now=new Date();
  if(period==="WEEK"){ const d=new Date(now); d.setDate(d.getDate()-6); d.setHours(0,0,0,0); return d.toISOString(); }
  if(period==="MONTH"){ const d=new Date(now.getFullYear(), now.getMonth(), 1); return d.toISOString(); }
  return null;
}
function renderCountryButtons(rows){
  const box = $("#countrySeg");
  const set = new Set(rows.map(r => (r.country||"KR").toUpperCase()));
  set.add("ALL"); set.add(USER_COUNTRY);
  const list = [...set].sort();
  box.innerHTML = "";
  list.forEach(c=>{
    const b=document.createElement("button");
    b.textContent=c; b.dataset.c=c;
    if(c===currentCountry) b.classList.add("active");
    b.addEventListener("click",()=>{
      box.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); currentCountry=c; renderLeaderboard(latestRows);
    });
    box.appendChild(b);
  });
  const active = box.querySelector(`button[data-c="${currentCountry}"]`) || box.querySelector('button[data-c="ALL"]');
  if(active){ box.querySelectorAll("button").forEach(x=>x.classList.remove("active")); active.classList.add("active"); }
}
function renderLeaderboard(rows){
  latestRows = rows.slice();
  const filtered = currentCountry==="ALL" ? rows : rows.filter(r => (r.country||"").toUpperCase()===currentCountry);
  const tb=$("#leader-tbody"); tb.innerHTML="";
  filtered.slice(0,50).forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="text-align:right;padding:6px">${i+1}</td>
      <td style="padding:6px">${r.nickname??"-"}</td>
      <td style="padding:6px">${r.country??"-"}</td>
      <td style="text-align:right;padding:6px">${r.score??0}</td>`;
    tb.appendChild(tr);
  });
}
function startLeaderboard(period="ALL"){
  if(!RTDB_ENABLED) return;
  if(currentRef) currentRef.off();
  const startISO = getPeriodStartISO(period);
  if(startISO){
    currentRef = db.ref("scores_v1").orderByChild("date").startAt(startISO).limitToLast(500);
  }else{
    currentRef = db.ref("scores_v1").orderByChild("date").limitToLast(500);
  }
  currentRef.on("value", snap=>{
    const arr=[]; snap.forEach(c=>arr.push(c.val()));
    arr.sort((a,b)=>(b.score||0)-(a.score||0));
    renderCountryButtons(arr);
    renderLeaderboard(arr);
  });
}
function wirePeriodUI(){
  const seg=$("#periodSeg"); seg.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      seg.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentPeriod = btn.dataset.p;
      startLeaderboard(currentPeriod);
    });
  });
}

/* ---------------- 테트리스 (막대기 비율↑ + 12회 이내 보장) ---------------- */
const cvs=$("#game"), ctx=cvs.getContext("2d");
const COL=10, ROW=20, CELL=24; cvs.width=COL*CELL; cvs.height=ROW*CELL;
const COLORS=["#000","#36b24d","#5bc0de","#f0ad4e","#d9534f","#8e44ad","#3498db","#2ecc71"];
const SHAPES={
  I:[[1,1,1,1]],
  O:[[2,2],[2,2]],
  T:[[0,3,0],[3,3,3]],
  S:[[0,4,4],[4,4,0]],
  Z:[[5,5,0],[0,5,5]],
  J:[[6,0,0],[6,6,6]],
  L:[[0,0,7],[7,7,7]]
};
/* 가중치: I≈28%, 나머지 분배 */
const TYPES = ["I","O","T","S","Z","J","L"];
const WEIGHTS = { I:0.28, O:0.12, T:0.16, S:0.12, Z:0.12, J:0.10, L:0.10 };
let sinceI = 0;

function weightedPick(){
  const r = Math.random(); let acc=0;
  for(const t of TYPES){ acc+=WEIGHTS[t]; if(r<=acc) return t; }
  return "T";
}
function pickTypeWithGuarantee(){
  if(sinceI>=11){ sinceI=0; return "I"; }
  const t = weightedPick();
  if(t==="I") sinceI=0; else sinceI++;
  return t;
}
const rndShape=()=> SHAPES[pickTypeWithGuarantee()].map(r=>r.slice());

const board=Array.from({length:ROW},()=>Array(COL).fill(0));
let piece=null, score=0, lines=0, level=1, running=false, startMs=0, lastDrop=0, rafId=0;

const rotate=m=>{const h=m.length,w=m[0].length,n=Array.from({length:w},()=>Array(h).fill(0));for(let y=0;y<h;y++)for(let x=0;x<w;x++)n[x][h-1-y]=m[y][x];return n;};
function collides(nx,ny,m=piece?.m){if(!m) return false;for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){if(!m[y][x])continue;const px=nx+x,py=ny+y;if(px<0||px>=COL||py>=ROW)return true;if(py>=0 && board[py][px])return true;}return false;}
function merge(){ if(!piece) return; piece.m.forEach((row,dy)=>row.forEach((v,dx)=>{ if(v&&piece.y+dy>=0) board[piece.y+dy][piece.x+dx]=v; })); }
function clearLines(){ let c=0; for(let y=ROW-1;y>=0;y--){ if(board[y].every(v=>v)){ board.splice(y,1); board.unshift(Array(COL).fill(0)); c++; y++; } } if(c){ const add=[0,100,300,500,800][c]; score+=add; lines+=c; level=1+Math.floor(lines/10); } }
function spawn(){ piece={m:rndShape(),x:3,y:0}; return !collides(piece.x,piece.y,piece.m); }
function drawCell(x,y,v){ ctx.fillStyle=v?COLORS[v]:"#0a0f22"; ctx.fillRect(x*CELL,y*CELL,CELL-1,CELL-1); }
function draw(){ for(let y=0;y<ROW;y++) for(let x=0;x<COL;x++) drawCell(x,y,board[y][x]); if(piece){ piece.m.forEach((row,dy)=>row.forEach((v,dx)=>{ if(v&&piece.y+dy>=0) drawCell(piece.x+dx,piece.y+dy,v); })); } $("#sc").textContent=score; $("#ln").textContent=lines; $("#lv").textContent=level; }
function stepDown(){ if(!piece) return; if(!collides(piece.x,piece.y+1,piece.m)){ piece.y++; } else { merge(); clearLines(); if(!spawn()){ gameOver(); return; } } }
function softDrop(){ if(!piece) return; if(!collides(piece.x,piece.y+1,piece.m)){ piece.y++; score+=1; } }
function hardDrop(){ if(!piece) return; let moved=0; while(!collides(piece.x,piece.y+1,piece.m)){ piece.y++; moved++; } score+=2*moved; merge(); clearLines(); if(!spawn()){ gameOver(); return; } draw(); }
function tick(){ if(!running) return; const speed=Math.max(70,720 - level*55); const now=performance.now(); if(now-lastDrop>speed){ stepDown(); lastDrop=now; } draw(); rafId=requestAnimationFrame(tick); }

/* 닉네임 필수 + 팝업 제어 */
function validateNick(){
  const ok = ($("#nickname")?.value || "").trim().length >= 2;
  $("#btnStart").disabled = !ok;
  return ok;
}
function getNickname(){
  const v = ($("#nickname")?.value || "").trim();
  if(v.length < 2){
    $("#ovTitle").textContent = "닉네임 2자 이상 입력하세요";
    return null;
  }
  localStorage.setItem("nick", v);
  return v.slice(0,20);
}
function openStartOverlay(title="게임 시작"){
  $("#ovTitle").textContent = title;
  $("#startOverlay").style.display="flex";
  $("#gameOver").style.display="none";
  $("#nickname").focus();
}
function closeStartOverlay(){
  $("#startOverlay").style.display="none";
}

function gameStart(){
  if(!validateNick()) return;
  const nick = getNickname();
  if(!nick) return;

  closeStartOverlay();
  cancelAnimationFrame(rafId);
  for(const r of board) r.fill(0);
  score=0; lines=0; level=1; piece=null; sinceI=0;
  if(!spawn()){ gameOver(); return; }
  running=true; startMs=Date.now(); lastDrop=0;
  requestAnimationFrame(tick);
}
function gameOver(){
  if(!running) return;
  running=false;
  $("#gameOver").style.display="flex";
  const nick = getNickname();
  if(nick){
    const dur = Date.now()-startMs;
    submitScore(nick, score, USER_COUNTRY, dur);
  }
  // 게임 오버 후 자동으로 시작 팝업을 열어 재시작 유도
  setTimeout(()=>openStartOverlay("재시작 / Restart"), 600);
}

/* 키/터치 */
window.addEventListener("keydown",e=>{
  // 팝업에서 Enter → 시작
  if(e.key==="Enter" && $("#startOverlay").style.display!=="none"){
    e.preventDefault(); gameStart(); return;
  }
  if(!running||!piece) return;
  if(e.code==="ArrowLeft" && !collides(piece.x-1,piece.y,piece.m)) piece.x--;
  else if(e.code==="ArrowRight" && !collides(piece.x+1,piece.y,piece.m)) piece.x++;
  else if(e.code==="ArrowDown"){ if(!collides(piece.x,piece.y+1,piece.m)) softDrop(); }
  else if(e.code==="ArrowUp"){ const r=rotate(piece.m); if(!collides(piece.x,piece.y,r)) piece.m=r; }
  else if(e.code==="Space"){ e.preventDefault(); hardDrop(); }
  draw();
});
const ctrls=document.querySelectorAll(".ctl"); let holdTimer=null, repeatTimer=null;
function startHold(action){ doAction(action); holdTimer=setTimeout(()=>{ repeatTimer=setInterval(()=>doAction(action),80); },280); }
function endHold(){ clearTimeout(holdTimer); clearInterval(repeatTimer); }
function doAction(act){
  if(!running||!piece) return;
  if(act==="left" && !collides(piece.x-1,piece.y,piece.m)) piece.x--;
  else if(act==="right" && !collides(piece.x+1,piece.y,piece.m)) piece.x++;
  else if(act==="down"){ if(!collides(piece.x,piece.y+1,piece.m)) softDrop(); }
  else if(act==="rotate"){ const r=rotate(piece.m); if(!collides(piece.x,piece.y,r)) piece.m=r; }
  else if(act==="drop"){ hardDrop(); }
  draw();
}
ctrls.forEach(btn=>{
  btn.addEventListener("touchstart",e=>{ e.preventDefault(); startHold(btn.dataset.act); },{passive:false});
  btn.addEventListener("touchend",e=>{ e.preventDefault(); endHold(); },{passive:false});
  btn.addEventListener("mousedown",e=>{ e.preventDefault(); startHold(btn.dataset.act); });
  btn.addEventListener("mouseup",e=>{ e.preventDefault(); endHold(); });
  btn.addEventListener("mouseleave",e=>{ e.preventDefault(); endHold(); });
});

/* 초기화 */
$("#btnStart").addEventListener("click", ()=>gameStart());
$("#nickname").addEventListener("input", validateNick);
$("#nickname").value = localStorage.getItem("nick") || "";
validateNick();

detectCountry();
wirePeriodUI();
startLeaderboard(currentPeriod);
purgeGuestOnce();   // Guest4701 자동 삭제(최초 1회)
draw();
document.addEventListener("touchstart",()=>{ document.getElementById("touchCtrls").style.display="flex"; },{once:true});
</script>
</body>
</html>
