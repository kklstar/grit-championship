<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>천하제일 근성 대회</title>
<style>
  :root{
    --bg:#0e1624; --panel:#111b2c; --fg:#cfe7ff; --muted:#96a9c8; --line:#1f2b44;
    --accent:#4db6ff; --danger:#ff5666; --ok:#2ecc71; --gold:#ffd86b;
    --tileI:#7fd0ff; --tileJ:#6cb1ff; --tileL:#ffa45b;
    --tileO:#ffdf6d; --tileS:#44d084; --tileT:#ff7aa1; --tileZ:#57c6ff; /* NOTE: palette 고정 */
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-block;background:#0b223e;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
  .badge.active{background:#133a6e}
  .status{display:flex;justify-content:space-between;margin-top:8px;font-size:14px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
  .muted{color:var(--muted)}
  /* 보드 */
  .board{position:relative;aspect-ratio:10/20;width:100%;max-width:360px;margin:0 auto;background:linear-gradient(transparent 24px, var(--line) 24px),linear-gradient(90deg, transparent 24px, var(--line) 24px);
    background-size:25px 25px,25px 25px;background-position:0 0,0 0;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  canvas{display:block;width:100%;height:100%}
  .legend{display:flex;justify-content:space-between;margin-top:8px}
  /* 모달 */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:20;padding:16px}
  .modal.show{display:flex}
  .modal .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;max-width:320px;width:100%}
  .box h3{margin:0 0 8px 0}
  input[type="text"]{width:100%;border:1px solid var(--line);background:#0c1526;color:var(--fg);
    border-radius:10px;padding:10px 12px;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#153152;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ok{background:linear-gradient(180deg,#1ea464,#15864f)}
  .btn.ghost{background:transparent}
  .row-just{display:flex;gap:8px;justify-content:space-between}
  /* 모바일 조작키 */
  .mobile-keys{display:none;gap:8px;margin-top:10px;flex-wrap:wrap}
  .mkey{flex:1 1 auto;min-width:60px;background:#0e2b4c;border:1px solid var(--line);border-radius:12px;padding:10px;font-weight:700;text-align:center}
  @media (max-width:980px){.mobile-keys{display:flex}}
  /* 색상(블록) */
  .cI{background:var(--tileI)} .cJ{background:var(--tileJ)} .cL{background:var(--tileL)}
  .cO{background:var(--tileO)} .cS{background:var(--tileS)} .cT{background:var(--tileT)} .cZ{background:var(--tileZ)}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <span class="badge">KR</span>
    <span class="badge" id="fbStatus">Firebase 연결 OK / Connected — 점수 업로드 가능</span>
  </div>

  <div class="grid mt12">
    <!-- 게임 패널 -->
    <div class="card">
      <div class="board"><canvas id="game"></canvas></div>
      <div class="legend muted">
        <div>점수 <b id="sc">0</b></div>
        <div>라인 <b id="ln">0</b></div>
        <div>레벨 <b id="lv">1</b></div>
      </div>

      <!-- 모바일 조작키 -->
      <div class="mobile-keys">
        <button class="mkey" data-act="left">◀</button>
        <button class="mkey" data-act="rotate">↻</button>
        <button class="mkey" data-act="right">▶</button>
        <button class="mkey" data-act="soft">⬇</button>
        <button class="mkey" data-act="hard">⤓</button>
      </div>

      <div class="card mt12 muted">
        조작: ← → 이동 · ↑ 회전 · ↓ 소프트드롭 · Space 하드드롭 (클래식)
      </div>
    </div>

    <!-- 리더보드 -->
    <div class="card">
      <div class="row">
        <button class="badge active" data-range="all">ALL</button>
        <button class="badge" data-range="week">This Week</button>
        <button class="badge" data-range="month">This Month</button>
        <span class="badge active" id="feedLive">실시간 업데이트 (Firebase RTDB)</span>
        <span class="badge" id="feedSaved">점수 저장 완료 / Saved</span>
        <span style="margin-left:auto" class="badge active" data-country="ALL">ALL</span>
        <span class="badge" data-country="KR">KR</span>
      </div>

      <div class="card mt12" id="liveBar" style="background:#0e302b;border-color:#12483f;color:#8efccc">
        랭킹 연동 전 — 게임 정상 동작 확인용 레이아웃
      </div>

      <table class="table mt12" id="rank">
        <thead>
          <tr>
            <th>#</th>
            <th>닉네임 / Nickname</th>
            <th>국가 / Country</th>
            <th>점수 / Score</th>
          </tr>
        </thead>
        <tbody id="rankBody">
          <!-- rows -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 시작 모달 -->
<div class="modal show" id="startModal">
  <div class="box">
    <h3>시작 / Restart</h3>
    <div class="muted">닉네임을 입력하고 시작하세요.</div>
    <input id="nickInput" type="text" class="mt8" placeholder="닉네임 / Nickname (2자 이상)" maxlength="16" />
    <div class="row-just mt12">
      <button class="btn ghost" id="startCancel">취소</button>
      <button class="btn ok" id="startBtn">시작</button>
    </div>
  </div>
</div>

<!-- 게임오버 모달 -->
<div class="modal" id="overModal">
  <div class="box">
    <h3 style="color:var(--danger)">GAME OVER</h3>
    <div class="muted">닉네임과 점수를 확인하고 저장할 수 있어요.</div>
    <div class="mt12">
      <div class="muted">닉네임</div>
      <input id="overNick" type="text" maxlength="16" />
    </div>
    <div class="mt8 muted">점수 <b id="overScore">0</b></div>
    <div class="row-just mt12">
      <button class="btn" id="restart">재시작</button>
      <button class="btn ok" id="saveScore">점수 저장</button>
    </div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ---------------- Firebase 설정 (사용 중인 프로젝트 값 그대로 넣으세요) ---------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "grit-championship-v02.firebaseapp.com",
  databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
  projectId: "grit-championship-v02",
  storageBucket: "grit-championship-v02.firebasestorage.app",
  messagingSenderId: "644513888198",
  appId: "1:644513888198:web:baa0728174614bb68124c7",
  measurementId: "G-F8JGH16CR6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- 국가 가져오기 (Cloudflare Worker: /country) ---------------- */
async function getCountry() {
  try{
    const r = await fetch('/country',{cache:'no-store'});
    if(!r.ok) return 'KR';
    const j = await r.json();
    return (j.country||'KR').toUpperCase();
  }catch{ return 'KR'; }
}
function countryCodeToEmoji(cc){
  if(!cc) return '';
  return cc.toUpperCase().replace(/./g,c=>String.fromCodePoint(127397+c.charCodeAt()));
}

/* ---------------- 유틸 ---------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let CURRENT_COUNTRY = 'KR';
let CURRENT_NICK = '';
let SUBMITTED_THIS_RUN = false;
let RANGE_FILTER = 'all';   // all/week/month
let COUNTRY_FILTER = 'ALL'; // ALL or KR

/* ---------------- 랭킹 실시간 구독 ---------------- */
let liveRef = null, liveCb = null;
function subscribeLeaderboard(){
  if(liveRef && liveCb){ liveRef.off('value',liveCb); }
  liveRef = db.ref('scores'); // { timestamp, nick, score, country }
  liveCb = snap=>{
    const list = [];
    snap.forEach(child=>{
      const v = child.val(); v._id = child.key; list.push(v);
    });
    renderLeaderboard(list);
  };
  liveRef.on('value', liveCb);
}
function withinRange(ts){
  if(RANGE_FILTER==='all') return true;
  const d = new Date(ts);
  const now = new Date();
  if(RANGE_FILTER==='week'){
    const weekStart = new Date(now); weekStart.setDate(now.getDate()-6); weekStart.setHours(0,0,0,0);
    return d>=weekStart && d<=now;
  }
  if(RANGE_FILTER==='month'){
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    return d>=monthStart && d<=now;
  }
  return true;
}
function renderLeaderboard(list){
  const tbody = $('#rankBody'); tbody.innerHTML='';
  const filtered = list
    .filter(v=>withinRange(v.timestamp))
    .filter(v=>COUNTRY_FILTER==='ALL' ? true : (v.country||'KR')===COUNTRY_FILTER)
    .sort((a,b)=>b.score-a.score)
    .slice(0,50);

  filtered.forEach((v,i)=>{
    const tr = document.createElement('tr');
    const cc = (v.country||'KR').toUpperCase();
    tr.innerHTML = `
      <td class="muted">${i+1}</td>
      <td>${escapeHtml(v.nick||'Guest')}</td>
      <td>${countryCodeToEmoji(cc)} ${cc}</td>
      <td><b>${v.score|0}</b></td>
    `;
    tbody.appendChild(tr);
  });
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ---------------- 테트리스 (클래식 간이 구현) ---------------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const COLS=10, ROWS=20, SIZE=25; // grid size
canvas.width = COLS*SIZE; canvas.height = ROWS*SIZE;

const SHAPES = {
  I:[[1,1,1,1]],
  J:[[2,0,0],[2,2,2]],
  L:[[0,0,3],[3,3,3]],
  O:[[4,4],[4,4]],
  S:[[0,5,5],[5,5,0]],
  T:[[0,6,0],[6,6,6]],
  Z:[[7,7,0],[0,7,7]],
};
const COLORS = {1:'var(--tileI)',2:'var(--tileJ)',3:'var(--tileL)',4:'var(--tileO)',5:'var(--tileS)',6:'var(--tileT)',7:'var(--tileZ)'};

const emptyRow = () => Array(COLS).fill(0);
let arena = Array.from({length:ROWS}, emptyRow);
let piece = null;
let score=0, lines=0, level=1;
let dropInterval = 800, lastTime=0, acc=0;
let playing = false;

function newPiece(){
  const keys = Object.keys(SHAPES);
  const k = keys[(Math.random()*keys.length)|0];
  const shape = SHAPES[k].map(r=>r.slice());
  return {shape,x:3,y:0};
}
function rotate(mat){
  const N=mat.length,M=mat[0].length;
  const res = Array.from({length:M},()=>Array(N).fill(0));
  for(let y=0;y<N;y++)for(let x=0;x<M;x++) res[x][N-1-y]=mat[y][x];
  return res;
}
function collide(ar, p){
  const m = p.shape;
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(m[y][x] && (ar[p.y+y]==null || ar[p.y+y][p.x+x]==null || ar[p.y+y][p.x+x])){
        return true;
      }
    }
  }
  return false;
}
function merge(ar,p){
  p.shape.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v){ ar[p.y+y][p.x+x]=v; }
    });
  });
}
function clearLines(){
  let cleared=0;
  outer: for(let y=arena.length-1;y>=0;y--){
    for(let x=0;x<COLS;x++){
      if(!arena[y][x]) continue outer;
    }
    arena.splice(y,1);
    arena.unshift(emptyRow());
    cleared++; y++;
  }
  if(cleared){
    const points = [0,100,300,500,800][cleared]||cleared*100;
    score += points;
    lines += cleared;
    if(lines>= (level*10)){ level++; dropInterval = Math.max(120, dropInterval-60); }
    updateHUD();
  }
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // arena
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const v=arena[y][x]; if(v){
        ctx.fillStyle = COLORS[v]; ctx.fillRect(x*SIZE,y*SIZE,SIZE-1,SIZE-1);
      }
    }
  }
  // piece
  if(piece){
    piece.shape.forEach((row,yy)=>{
      row.forEach((v,xx)=>{
        if(v){
          ctx.fillStyle = COLORS[v];
          ctx.fillRect((piece.x+xx)*SIZE,(piece.y+yy)*SIZE,SIZE-1,SIZE-1);
        }
      });
    });
  }
}
function updateHUD(){
  $('#sc').textContent = score;
  $('#ln').textContent = lines;
  $('#lv').textContent = level;
}
function topOut(ar){
  // 최상단에 블록이 들어가면 Game Over
  for(let x=0;x<COLS;x++){
    if(ar[0][x]) return true;
  }
  return false;
}
function drop(){
  piece.y++;
  if(collide(arena,piece)){
    piece.y--;
    merge(arena,piece);
    clearLines();
    if(topOut(arena)){ endGame(); return; }
    piece = spawn(); // 다음
    // 스폰 즉시 충돌 = 탑아웃
    if(collide(arena,piece)){ endGame(); return; }
  }
}
function spawn(){
  const p = newPiece();
  // 스폰 위치에서 충돌 체크 – 충돌하면 Game Over
  if(collide(arena,p)){ endGame(); }
  return p;
}
function endGame(){
  playing=false;
  SUBMITTED_THIS_RUN=false;
  $('#overScore').textContent = score;
  $('#overNick').value = CURRENT_NICK||'';
  $('#overModal').classList.add('show');
}
function gameStart(){
  // 초기화
  arena = Array.from({length:ROWS}, emptyRow);
  piece = newPiece();
  score=0; lines=0; level=1; dropInterval=800; lastTime=0; acc=0;
  playing=true; SUBMITTED_THIS_RUN=false;
  updateHUD();
  requestAnimationFrame(loop);
}
function loop(t){
  if(!playing) return;
  const dt = t - lastTime; lastTime=t; acc+=dt;
  if(acc>dropInterval){ drop(); acc=0; }
  draw();
  requestAnimationFrame(loop);
}
// 이동/회전
function tryOffset(dx,dy=0,rot=false){
  const prev = piece.shape;
  if(rot) piece.shape = rotate(piece.shape);
  piece.x += dx; piece.y += dy;
  if(collide(arena,piece)){
    piece.x -= dx; piece.y -= dy;
    if(rot) piece.shape = prev;
    return false;
  }
  return true;
}
// 키
document.addEventListener('keydown',e=>{
  if(!playing) return;
  if(e.code==='ArrowLeft'){ tryOffset(-1,0); }
  else if(e.code==='ArrowRight'){ tryOffset(1,0); }
  else if(e.code==='ArrowUp'){ tryOffset(0,0,true); }
  else if(e.code==='ArrowDown'){ tryOffset(0,1); score+=1; updateHUD(); }
  else if(e.code==='Space'){ // 하드드롭
    e.preventDefault();
    let fell=0;
    while(tryOffset(0,1)) fell++;
    score += 2*fell; updateHUD();
  }
});
$('.mobile-keys').addEventListener('click',e=>{
  const b = e.target.closest('.mkey'); if(!b) return;
  const act=b.dataset.act;
  if(act==='left') tryOffset(-1,0);
  if(act==='right') tryOffset(1,0);
  if(act==='rotate') tryOffset(0,0,true);
  if(act==='soft'){ tryOffset(0,1); score+=1; updateHUD(); }
  if(act==='hard'){
    let fell=0; while(tryOffset(0,1)) fell++; score += 2*fell; updateHUD();
  }
});

/* ---------------- 모달 & 저장 ---------------- */
$('#startBtn').addEventListener('click', async ()=>{
  const nick = ($('#nickInput').value||'').trim();
  if(nick.length<2){ alert('닉네임은 2자 이상으로 입력해주세요.'); return; }
  CURRENT_NICK = nick;
  CURRENT_COUNTRY = await getCountry();
  $('#startModal').classList.remove('show');
  gameStart();
});
$('#startCancel').addEventListener('click',()=>window.location.reload());
$('#restart').addEventListener('click',()=>{
  $('#overModal').classList.remove('show');
  $('#startModal').classList.add('show');
  $('#nickInput').value = CURRENT_NICK||'';
});
$('#saveScore').addEventListener('click', async ()=>{
  if(SUBMITTED_THIS_RUN){ alert('이번 판 점수는 이미 저장되었습니다.'); return; }
  const nick = ($('#overNick').value||CURRENT_NICK||'').trim();
  if(nick.length<2){ alert('닉네임은 2자 이상으로 입력해주세요.'); return; }
  CURRENT_NICK = nick;

  // 데모: key를 날짜/닉네임/타임스탬프 섞어서 — 운영 시 서버 검증 권장
  const today = new Date(); const dKey = today.toISOString().slice(0,10);
  const key = `scores/${Date.now()}`;
  const payload = { nick, score, country:CURRENT_COUNTRY||'KR', timestamp:Date.now(), date:dKey };

  try{
    await db.ref(key).set(payload);
    SUBMITTED_THIS_RUN = true;
    $('#overModal').classList.remove('show');
    $('#liveBar').textContent = '점수 저장 완료 / Saved';
    $('#liveBar').style.background = '#0e302b';
    $('#liveBar').style.borderColor = '#12483f';
    $('#liveBar').style.color = '#8efccc';
  }catch(err){
    alert('저장 실패: '+err.message);
  }
});

/* ---------------- 필터 버튼 ---------------- */
$$('.badge[data-range]').forEach(b=>{
  b.addEventListener('click',()=>{
    $$('.badge[data-range]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    RANGE_FILTER = b.dataset.range;
    // 최신 스냅샷 다시 렌더 (실시간 구독 중)
    if(liveRef && liveCb) liveRef.once('value',s=>liveCb(s));
  });
});
$$('.badge[data-country]').forEach(b=>{
  b.addEventListener('click',()=>{
    $$('.badge[data-country]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    COUNTRY_FILTER = b.dataset.country;
    if(liveRef && liveCb) liveRef.once('value',s=>liveCb(s));
  });
});
$('#feedLive').addEventListener('click',()=>{
  $('#feedLive').classList.add('active'); $('#feedSaved').classList.remove('active');
  $('#liveBar').textContent='실시간 업데이트 (Firebase RTDB)';
});
$('#feedSaved').addEventListener('click',()=>{
  $('#feedSaved').classList.add('active'); $('#feedLive').classList.remove('active');
  $('#liveBar').textContent='점수 저장 완료 / Saved';
});

/* ---------------- 초기화 ---------------- */
(async function init(){
  try{
    subscribeLeaderboard();
    $('#fbStatus').textContent = 'Firebase 연결 OK / Connected — 점수 업로드 가능';
  }catch{ $('#fbStatus').textContent = 'Firebase 연결 오류 — 연결을 확인하세요'; }
  // 시작 시 국가 미리 로드(딜레이 방지)
  try{ CURRENT_COUNTRY = await getCountry(); }catch{}
})();
</script>
</body>
</html>
