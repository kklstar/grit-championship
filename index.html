<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ (World Grit Championship)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#0b1020; --panel:#0f1630; --fg:#e7f0ff; --muted:#99a8c7; --line:#1b2548;
    --accent:#49b2ff; --danger:#ff5666; --ok:#2ecc71; --gold:#ffd86b;
  }
  *{box-sizing:border-box}
  body { margin:0; background:var(--bg); color:var(--fg); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
  header { padding:12px 16px; border-bottom:1px solid var(--line); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; letter-spacing:.2px; }
  .flag { display:inline-block; border:1px solid rgba(255,255,255,.15); padding:2px 8px; border-radius:999px; font-size:12px; }
  main { display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; }
  @media (max-width: 1080px){ main{ grid-template-columns: 1fr; } }

  .card { background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  input[type=text]{ background:#0e1430; color:var(--fg); border:1px solid #1e2a55; padding:8px 10px; border-radius:10px; outline:none; }
  button{ background:linear-gradient(180deg,#3aa9ff,#0685ff); color:#fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
  button.ghost{ background:transparent; border:1px solid #2a3770; color:#cfe0ff }
  canvas{ background:#0a0f22; border:1px solid #223060; border-radius:12px; display:block; margin:auto; outline:none; }
  .stats{ display:flex; justify-content:space-between; margin-top:8px; font-size:14px; }

  /* íƒ­ */
  .tabs { display:flex; gap:6px; border-bottom:1px solid var(--line); margin-bottom:10px; }
  .tab { padding:8px 10px; border:1px solid var(--line); border-bottom:none; border-radius:10px 10px 0 0; background:#0e1430; cursor:pointer; font-size:13px; }
  .tab.active { background:#15224a; color:#fff; font-weight:700; }
  .tabpanes > section { display:none; }
  .tabpanes > section.active { display:block; }

  table{ width:100%; border-collapse:collapse; }
  th,td{ text-align:left; padding:8px; border-bottom:1px dashed rgba(255,255,255,.08); font-size:14px; }
  th{ color:#cfe0ff; }
  td.rank{ width:56px; color:#9fc8ff; font-weight:700; }
  .muted{ color:var(--muted); font-size:12px; }
  footer{ text-align:center; color:#9fb2de; font-size:12px; padding:10px 0 20px; }
  .warn{ color:#ffd266 }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 480px){ .grid2{ grid-template-columns: 1fr; } }

  /* ìƒíƒœë°” */
  #status { padding:10px 16px; font-size:13px; display:none; }
  .danger { background:rgba(255,86,102,.12); border-top:1px solid rgba(255,86,102,.4); color:#ffb3bb; }
  .ok { background:rgba(46,204,113,.12); border-top:1px solid rgba(46,204,113,.4); color:#c9f7d9; }

  /* ê´‘ê³  ìŠ¬ë¡¯ */
  .ad { background:#0b122a; border:1px dashed #334070; border-radius:12px; padding:10px; color:#9fb4ff; text-align:center; }
  .ad small{ color:#8aa2ff }
  .ad-sidebar { min-height:120px }
  .ad-top { margin:10px 0 }
  .ad-interstitial { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000; }
  .ad-modal { background:#0e1736; border:1px solid #2b3d78; border-radius:16px; padding:16px; width:min(90vw, 420px); text-align:center; }
  .ad-actions { display:flex; gap:8px; justify-content:center; margin-top:10px; }

  /* ê²Œì„ì˜¤ë²„ ì˜¤ë²„ë ˆì´ */
  .gold { color:var(--gold); }
</style>
</head>
<body>
<header>
  <h1>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ (World Grit Championship)</h1>
  <div class="row">
    <label class="muted">ë‹‰ë„¤ì„ / Nickname</label>
    <input id="nickname" type="text" maxlength="20" placeholder="Guest1234" />
    <button id="btnStart" type="button">ê²Œì„ ì‹œì‘ / Start</button>
    <button id="btnRestart" class="ghost" type="button">ì¬ì‹œì‘ / Restart</button>
    <span id="countryTag" class="flag">??</span>
  </div>
</header>

<div id="status"></div>

<main>
  <!-- ì¢Œì¸¡: ê²Œì„ + ìƒë‹¨ ë°°ë„ˆ ê´‘ê³  -->
  <section class="card">
    <div class="ad ad-top" id="adTop"><b>AD</b><br><small>Top Banner Slot â€” ì—¬ê¸°ì— AdSense/ê´‘ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚½ì…í•˜ì„¸ìš”</small></div>
    <canvas id="board" width="300" height="600" tabindex="0"></canvas>
    <div class="stats">
      <div>ì ìˆ˜ / Score <b id="score">0</b></div>
      <div>ë¼ì¸ / Lines <b id="lines">0</b></div>
      <div>ë ˆë²¨ / Level <b id="level">1</b></div>
    </div>
    <div style="margin-top:8px" class="muted">
      ì¡°ì‘: â† â†’ ì´ë™ | â†‘ íšŒì „ | â†“ ì†Œí”„íŠ¸ë“œë¡­ | Space í•˜ë“œë“œë¡­<br>
      Controls: â† â†’ Move | â†‘ Rotate | â†“ Soft Drop | Space Hard Drop
    </div>
    <div class="muted" style="margin-top:6px">
      * êµ­ê°€ëŠ” <b>IP ê¸°ì¤€</b>ì…ë‹ˆë‹¤. VPN/í”„ë¡ì‹œ ì‚¬ìš© ì‹œ ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      * Country is determined by IP. VPN/Proxy may affect accuracy.
    </div>
    <div class="muted" style="margin-top:6px">
      <span class="warn">ì£¼ì˜ / Note:</span> ë°ëª¨ ë²„ì „ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ìˆ˜ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ìš´ì˜ ì‹œ ì„œë²„ ê²€ì¦ì„ ë°˜ë“œì‹œ ì¶”ê°€í•˜ì„¸ìš”.
    </div>
  </section>

  <!-- ìš°ì¸¡: ë­í‚¹ + ì‚¬ì´ë“œ ê´‘ê³  -->
  <section class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-pane="pane-global">ğŸŒ ê¸€ë¡œë²Œ / Global</div>
      <div class="tab" data-pane="pane-country">ğŸ³ï¸ êµ­ê°€ë³„ / Country</div>
      <div class="tab" data-pane="pane-week">ğŸ“… ì´ë²ˆ ì£¼ / This Week</div>
    </div>
    <div class="tabpanes">
      <section id="pane-global" class="active">
        <div class="grid2">
          <div><h3 style="margin:0 0 8px 0;">ë¦¬ë”ë³´ë“œ / Leaderboard (Top 50)</h3></div>
          <div class="row" style="justify-content:flex-end">
            <label class="muted">êµ­ê°€ / Country</label>
            <input id="countryFilter" type="text" maxlength="2" placeholder="ALL" style="width:70px;text-transform:uppercase"/>
            <button id="btnFilter" class="ghost" type="button">ì ìš© / Apply</button>
            <button id="btnClear" class="ghost" type="button">ì´ˆê¸°í™” / Reset</button>
          </div>
        </div>
        <table>
          <thead><tr><th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th></tr></thead>
          <tbody id="tbody-global"></tbody>
        </table>
        <div class="muted" id="lbHint" style="margin-top:8px;">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ / Real-time Updates (Firebase RTDB)</div>
      </section>

      <section id="pane-country">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">êµ­ê°€ë³„ ë­í‚¹ / By Country</h3>
          <div class="row">
            <label class="muted">êµ­ê°€ ì½”ë“œ / ISO-2</label>
            <input id="countryOnly" type="text" maxlength="2" placeholder="KR" style="width:70px;text-transform:uppercase">
            <button id="btnCountryOnly" class="ghost" type="button">ë³´ê¸° / View</button>
          </div>
        </div>
        <table>
          <thead><tr><th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th></tr></thead>
          <tbody id="tbody-country"></tbody>
        </table>
      </section>

      <section id="pane-week">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">ì´ë²ˆ ì£¼ ë­í‚¹ / This Week</h3>
          <div class="muted" id="weekLabel"></div>
        </div>
        <table>
          <thead><tr><th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th></tr></thead>
          <tbody id="tbody-week"></tbody>
        </table>
      </section>
    </div>
    <div class="ad ad-sidebar" id="adSidebar" style="margin-top:12px">
      <b>AD</b><br><small>Sidebar Slot â€” ì—¬ê¸°ì— ë°°ë„ˆ/ë„¤ì´í‹°ë¸Œ ê´‘ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚½ì…</small>
    </div>
  </section>
</main>

<footer>
  ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ (World Grit Championship) Â© â€” êµìœ¡/í”„ë¡œí† íƒ€ì´í•‘ìš©.<br>
  ìš´ì˜ ì „ì— ì„œë²„ ê²€ì¦ ë° ë³´ì•ˆ ê·œì¹™ì„ ê°•í™”í•˜ì„¸ìš”.
</footer>

<!-- ì¸í„°ìŠ¤í‹°ì…œ(ë³´ìƒí˜•) ê´‘ê³  ëª¨ë‹¬ (ë°ëª¨) -->
<div class="ad-interstitial" id="adInterstitial">
  <div class="ad-modal">
    <h3>ë³´ìƒí˜• ê´‘ê³  / Rewarded Ad (Demo)</h3>
    <div class="ad" style="margin-top:8px"><b>AD</b><br><small>Interstitial Slot â€” ê´‘ê³  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚½ì…</small></div>
    <p class="muted" style="margin-top:8px">ê´‘ê³ ê°€ ëë‚˜ë©´ ë³´ìƒì„ ì§€ê¸‰í•©ë‹ˆë‹¤. (ë°ëª¨: â€œì£¼ê°„ ë³´ë„ˆìŠ¤ +500ì â€)</p>
    <div class="ad-actions">
      <button id="btnAdWatched">ê´‘ê³  ì‹œì²­ ì™„ë£Œ / Complete</button>
      <button class="ghost" id="btnAdClose">ë‹«ê¸° / Close</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* =========================
   êµ¬ì„±
   ========================= */
const CONFIG = {
  USE_SERVER: false, // ì„œë²„ ê²€ì¦ ì‚¬ìš© ì‹œ true ë¡œ ë³€ê²½í•˜ê³  SERVER_URL ì„¤ì •
  SERVER_URL: "https://your-cloud-function-url/submitScore", // ì˜ˆ) https://<region>-<project>.cloudfunctions.net/submitScore
  WEEK_OFFSET: 0 // 0=ì´ë²ˆì£¼, -1=ì§€ë‚œì£¼ (UI ìˆ˜ì •í•´ì„œ ê³¼ê±°ì£¼ë„ ë³¼ ìˆ˜ ìˆê²Œ í™•ì¥ ê°€ëŠ¥)
};

/* =========================
   Firebase ì„¤ì • (ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´)
   ========================= */
// Firebase ì„¤ì • (ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´)
const firebaseConfig = {
  apiKey: "AIzaSyB3-abc123xyzEXAMPLE456",
  authDomain: "grit-championship-v02.firebaseapp.com",
  databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
  projectId: "grit-championship-v02",
  storageBucket: "grit-championship-v02.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcdef123456"
};

let RTDB_ENABLED = !( !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY" );
let app, db;
const statusBar = document.getElementById("status");
function setStatus(msg, ok=false){
  statusBar.textContent = msg;
  statusBar.className = ok ? "ok" : "danger";
  statusBar.style.display = "block";
}
try {
  app = firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  if (RTDB_ENABLED) setStatus("Firebase ì—°ê²° OK / Connected â€” ì ìˆ˜ ì—…ë¡œë“œ ê°€ëŠ¥", true);
} catch(e){
  RTDB_ENABLED = false;
  console.warn("Firebase init failed", e);
  setStatus("Firebase ë¯¸ì„¤ì • / Not configured â€” ë¦¬ë”ë³´ë“œ ë¹„í™œì„±í™” (ê²Œì„ì€ ê°€ëŠ¥)", false);
  const hint = document.getElementById("lbHint");
  if (hint) hint.innerText = "Firebase ë¯¸ì„¤ì • / Not configured";
}

/* =========================
   êµ­ê°€ ì½”ë“œ (IP)
   ========================= */
let myCountry="ZZ";
(async()=>{
  try {
    const r=await fetch("https://ipapi.co/json/");
    if(r.ok){ const j=await r.json(); myCountry=(j.country||"ZZ").toUpperCase().slice(0,2); }
  } catch(e) {}
  document.getElementById("countryTag").textContent=myCountry;
})();

/* =========================
   ì£¼(week) í‚¤ ìœ í‹¸
   ========================= */
function getISOWeekInfo(date=new Date()){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum=d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart)/86400000) + 1)/7);
  return {year:d.getUTCFullYear(), week:weekNo};
}
function getWeekKey(offset=0){
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + offset*7);
  const {year, week} = getISOWeekInfo(d);
  return `${year}-W${String(week).padStart(2,'0')}`;
}

/* =========================
   íƒ­ ì œì–´
   ========================= */
const tabsEl = document.getElementById("tabs");
tabsEl.addEventListener("click", (e)=>{
  const t = e.target.closest(".tab"); if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".tabpanes > section").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  document.getElementById(t.dataset.pane).classList.add("active");
});

/* =========================
   ë¦¬ë”ë³´ë“œ (ê¸€ë¡œë²Œ/êµ­ê°€ë³„/ì£¼ê°„)
   ========================= */
const tbodyGlobal  = document.getElementById("tbody-global");
const tbodyCountry = document.getElementById("tbody-country");
const tbodyWeek    = document.getElementById("tbody-week");
const countryFilterInput=document.getElementById("countryFilter");
document.getElementById("btnFilter").addEventListener("click", renderGlobal);
document.getElementById("btnClear").addEventListener("click", ()=>{ countryFilterInput.value=""; renderGlobal(); });
document.getElementById("btnCountryOnly").addEventListener("click", renderCountryOnly);
document.getElementById("weekLabel").textContent = `ì£¼ê°„í‚¤ / Week Key: ${getWeekKey(CONFIG.WEEK_OFFSET)}`;

let cacheGlobal = []; // scores_v1
let cacheWeek   = []; // weekly/<weekKey>
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[m])); }

function renderRows(tbody, rows){
  tbody.innerHTML = "";
  rows.slice(0,50).forEach((row,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td class="rank">${i+1}</td>
      <td>${escapeHtml(row.nickname)}</td>
      <td><span class="flag">${row.country || "ZZ"}</span></td>
      <td>${Number(row.score).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
  if(!rows.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">ë°ì´í„° ì—†ìŒ / No data</td>`;
    tbody.appendChild(tr);
  }
}

function renderGlobal(){
  const cf=(countryFilterInput.value||"").trim().toUpperCase().slice(0,2);
  const list = cacheGlobal
    .filter(r=>!cf || r.country===cf)
    .sort((a,b)=>b.score-a.score);
  renderRows(tbodyGlobal, list);
}
function renderCountryOnly(){
  const code = (document.getElementById("countryOnly").value || myCountry || "").trim().toUpperCase().slice(0,2);
  const list = cacheGlobal.filter(r=>r.country===code).sort((a,b)=>b.score-a.score);
  renderRows(tbodyCountry, list);
}
function renderWeek(){
  const list = cacheWeek.sort((a,b)=>b.score-a.score);
  renderRows(tbodyWeek, list);
}

function subscribeLeaderboards(){
  if(!RTDB_ENABLED){ renderGlobal(); renderCountryOnly(); renderWeek(); return; }
  // ê¸€ë¡œë²Œ
  db.ref("scores_v1").orderByChild("scoreNegative").limitToFirst(300).on("value",(snap)=>{
    cacheGlobal = []; snap.forEach(ch=>cacheGlobal.push(ch.val())); renderGlobal();
  });
  // ì£¼ê°„ (weekKey ë³„ë„ ë…¸ë“œ)
  const wk = getWeekKey(CONFIG.WEEK_OFFSET);
  db.ref(`weekly/${wk}`).orderByChild("scoreNegative").limitToFirst(300).on("value",(snap)=>{
    cacheWeek = []; snap.forEach(ch=>cacheWeek.push(ch.val())); renderWeek();
  });
}
subscribeLeaderboards();

/* =========================
   ì ìˆ˜ ì œì¶œ: ì„œë²„ ê²€ì¦(ì„ íƒ) ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸â†’RTDB
   ========================= */
async function submitScore(nickname, score, lines, durationMs){
  if(CONFIG.USE_SERVER){
    // ì„œë²„ë¡œ ì œì¶œ (ì¶”ì²œ: ì¹˜íŠ¸ ë°©ì§€/ì†ë„ ì œí•œ/ì„œëª… ê²€ì¦)
    try{
      const res = await fetch(CONFIG.SERVER_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
          nickname, score, lines, durationMs, country: myCountry,
          ts: Date.now()
        })
      });
      if(!res.ok) throw new Error("Server rejected");
      console.log("Server submit OK");
    }catch(e){
      console.error("Server submit failed:", e);
      setStatus("ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨ / Submit failed. Endpoint í™•ì¸.", false);
    }
    return;
  }

  // í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ ì—…ë¡œë“œ(ê°œë°œ/í”„ë¡œí† íƒ€ì´í•‘)
  if(!RTDB_ENABLED) return;
  if(durationMs < 3000 || score < 0 || lines < 0) return;
  const payload = { nickname: nickname.slice(0,20), score, lines, durationMs, country: myCountry, ts: Date.now(), scoreNegative: -score };
  try{
    await db.ref("scores_v1").push(payload);
    // ì£¼ê°„ ë…¸ë“œì—ë„ ì“°ê¸°
    const wk = getWeekKey(0);
    await db.ref(`weekly/${wk}`).push(payload);
  }catch(e){
    console.error("RTDB submit failed:", e);
    setStatus("ì—…ë¡œë“œ ì‹¤íŒ¨: ê·œì¹™/URL/í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸", false);
  }
}

/* =========================
   ê²Œì„ ë¡œì§ (ë²½í‚¥/í•˜ë“œë“œë¡­ fix/ì˜¤ë²„ë ˆì´)
   ========================= */
const COLS=10, ROWS=20, BS=30;
const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");
let grid, piece, nextTickAt, dropInterval, running=false;
let score=0, lines=0, level=1, startAt=0, gameOver=false;

const colors={0:"#0a0f22", I:"#24e0ff", O:"#ffd043", T:"#b794ff", S:"#6dff8c", Z:"#ff7a7a", J:"#7ab3ff", L:"#ffb56b"};
const SHAPES={ I:[[1,1,1,1]], O:[[1,1],[1,1]], T:[[0,1,0],[1,1,1]], S:[[0,1,1],[1,1,0]], Z:[[1,1,0],[0,1,1]], J:[[1,0,0],[1,1,1]], L:[[0,0,1],[1,1,1]] };
const TYPES=Object.keys(SHAPES);
function newGrid(){ return Array.from({length:ROWS},()=>Array(COLS).fill(0)); }
function randomPiece(){ const t=TYPES[(Math.random()*TYPES.length)|0]; const s=SHAPES[t].map(r=>r.slice()); return {t,shape:s,x:(COLS/2|0)-(s[0].length/2|0),y:0}; }
function rotate(mat){ const R=mat.length,C=mat[0].length,res=[]; for(let c=0;c<C;c++){const row=[];for(let r=R-1;r>=0;r--)row.push(mat[r][c]);res.push(row);} return res; }
function collide(g,p,ox=0,oy=0,shape=p.shape){ for(let y=0;y<shape.length;y++){ for(let x=0;x<shape[y].length;x++){ if(!shape[y][x]) continue; const nx=p.x+x+ox,ny=p.y+y+oy; if(nx<0||nx>=COLS||ny>=ROWS) return true; if(ny>=0 && g[ny][nx]) return true; } } return false; }
function merge(g,p){ for(let y=0;y<p.shape.length;y++)for(let x=0;x<p.shape[y].length;x++)if(p.shape[y][x]){ const ny=p.y+y,nx=p.x+x; if(ny>=0) g[ny][nx]=p.t; } }
function clearLines(g){
  let cleared=0;
  outer: for(let y=ROWS-1;y>=0;y--){
    for(let x=0;x<COLS;x++){ if(!g[y][x]) continue outer; }
    g.splice(y,1); g.unshift(Array(COLS).fill(0));
    cleared++; y++;
  }
  if(cleared>0){
    lines+=cleared;
    score += [0,40,100,300,1200][cleared] * level;
    level = 1 + Math.floor(lines/10);
    dropInterval = Math.max(80, 800 - (level-1)*60);
  }
}
function drawCell(x,y,t){ ctx.fillStyle=colors[t]||"#223"; ctx.fillRect(x*BS+1,y*BS+1,BS-2,BS-2); }
function drawOverlayGameOver(){
  ctx.save();
  ctx.fillStyle="rgba(0,0,0,0.55)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ffffff"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.font="bold 30px system-ui, sans-serif";
  ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 12);
  ctx.font="13px system-ui, sans-serif"; ctx.fillStyle="#cfe0ff";
  ctx.fillText("ì¬ì‹œì‘ / Restart ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ë„ì „!", canvas.width/2, canvas.height/2 + 16);
  ctx.restore();
}
function draw(){
  ctx.fillStyle="#060a18"; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) if(grid[y][x]) drawCell(x,y,grid[y][x]);
  if(piece){ for(let y=0;y<piece.shape.length;y++) for(let x=0;x<piece.shape[y].length;x++) if(piece.shape[y][x]){ const ny=piece.y+y, nx=piece.x+x; if(ny>=0) drawCell(nx,ny,piece.t); } }
  document.getElementById("score").textContent=String(score);
  document.getElementById("lines").textContent=String(lines);
  document.getElementById("level").textContent=String(level);
  if(gameOver) drawOverlayGameOver();
}
function handleGameOver(){
  running=false; gameOver=true;
  const nn=(document.getElementById("nickname").value||"").trim()||("Guest"+((Math.random()*9999)|0));
  submitScore(nn, score, lines, Date.now()-startAt);
  // ê²Œì„ì˜¤ë²„ ì‹œ ì¸í„°ìŠ¤í‹°ì…œ(ë³´ìƒí˜•) ë…¸ì¶œ (ë°ëª¨)
  showInterstitial();
  draw();
}
function tick(ts){
  if(!running) return;
  if(!nextTickAt) nextTickAt=ts+dropInterval;
  if(ts>=nextTickAt){
    if(!collide(grid,piece,0,1)) piece.y++;
    else { merge(grid,piece); clearLines(grid); piece=randomPiece(); if(collide(grid,piece,0,0)){ handleGameOver(); return; } }
    nextTickAt=ts+dropInterval;
  }
  draw(); requestAnimationFrame(tick);
}
function startGame(){
  grid=newGrid(); piece=randomPiece();
  score=0; lines=0; level=1; dropInterval=800; nextTickAt=0; running=true; gameOver=false;
  startAt=Date.now(); draw(); requestAnimationFrame(tick);
  document.getElementById("btnStart").blur(); document.getElementById("btnRestart").blur(); canvas.focus();
}
function move(dx){ if(!running) return; if(!collide(grid,piece,dx,0)) piece.x+=dx; draw(); }
function softDrop(){ if(!running) return; if(!collide(grid,piece,0,1)){ piece.y++; score+=1; } draw(); }
function hardDrop(){ if(!running) return; let d=0; while(!collide(grid,piece,0,1)){ piece.y++; d++; } score+=2*d; merge(grid,piece); clearLines(grid); piece=randomPiece(); if(collide(grid,piece,0,0)){ handleGameOver(); return; } draw(); }
function rotatePiece(){
  if(!running) return;
  const r=rotate(piece.shape);
  const kicks=[[0,0],[-1,0],[1,0],[-2,0],[2,0],[0,-1]];
  for(const [dx,dy] of kicks){ if(!collide(grid,piece,dx,dy,r)){ piece.shape=r; piece.x+=dx; piece.y+=dy; draw(); return; } }
}

/* í‚¤ ì…ë ¥: ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ */
window.addEventListener("keydown",(e)=>{
  const handled=["ArrowLeft","ArrowRight","ArrowDown","ArrowUp","Space"].includes(e.code);
  if(handled) e.preventDefault();
  if(e.code==="ArrowLeft") move(-1);
  else if(e.code==="ArrowRight") move(1);
  else if(e.code==="ArrowDown") softDrop();
  else if(e.code==="ArrowUp") rotatePiece();
  else if(e.code==="Space") hardDrop();
});
document.getElementById("btnStart").addEventListener("click",(ev)=>{ startGame(); ev.currentTarget.blur(); canvas.focus(); });
document.getElementById("btnRestart").addEventListener("click",(ev)=>{ startGame(); ev.currentTarget.blur(); canvas.focus(); });

/* =========================
   ê´‘ê³  ëª¨ë‹¬ (ë°ëª¨ìš©)
   ========================= */
const inter = document.getElementById("adInterstitial");
document.getElementById("btnAdWatched").addEventListener("click", ()=>{
  inter.style.display="none";
  // ë³´ìƒ ì˜ˆì‹œ: ì´ë²ˆì£¼ ì ìˆ˜ì— +500 ë³´ë„ˆìŠ¤(ë°ëª¨). ì‹¤ìš´ì˜ì€ ì„œë²„ì—ì„œ ì²˜ë¦¬ ê¶Œì¥.
  if(RTDB_ENABLED){
    const wk = getWeekKey(0);
    const nn=(document.getElementById("nickname").value||"").trim()||"Guest";
    const payload={ nickname:nn.slice(0,20), score:500, lines:0, durationMs:0, country:myCountry, ts:Date.now(), scoreNegative:-500, bonus:true };
    db.ref(`weekly/${wk}`).push(payload);
  }
});
document.getElementById("btnAdClose").addEventListener("click", ()=> inter.style.display="none");
function showInterstitial(){ inter.style.display="flex"; }
</script>
</body>
</html>

