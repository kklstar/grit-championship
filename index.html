<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ (World Grit Championship)</title>
<style>
  :root{
    --bg:#0b1020;--panel:#0f1630;--fg:#e7f0ff;--muted:#9aa6c7;--line:#1b2548;
    --accent:#4da3ff;--danger:#ff5666;--ok:#22cc71;--gold:#ffd86b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{font-size:18px;margin:0}
  .flag{display:inline-block;border:1px solid rgba(255,255,255,.15);padding:2px 8px;border-radius:999px;font-size:12px}
  main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px;max-width:1400px;margin:0 auto}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }

  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;position:relative}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* ìº”ë²„ìŠ¤ */
  canvas{background:#001328;border:1px solid #223068;border-radius:12px;display:block;margin:auto;outline:none}

  /* íŒì—… ì˜¤ë²„ë ˆì´ */
  .overlay{position:absolute;inset:14px;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:5;border-radius:12px}
  .overlay.open{display:flex}
  .overlay-card{width:260px;padding:18px;background:#111827;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);text-align:center}
  .overlay-card h3{margin:0 0 6px;font-size:18px}
  .overlay-card .hint{margin:0 0 12px;color:#9ca3af;font-size:13px}
  .overlay-card .field{margin-bottom:10px}
  #nickname{width:100%;height:38px;padding:0 10px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb;outline:none}
  #nickname:focus{border-color:#2563eb}
  .btn{height:34px;padding:0 12px;border-radius:8px;border:1px solid var(--line);background:#152044;color:var(--fg);cursor:pointer}
  .btn-primary{width:100%;height:38px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed}
  .controls{margin-top:12px;color:#9ca3af;font-size:12px}

  /* ë¦¬ë”ë³´ë“œ */
  table{width:100%;border-collapse:collapse}
  th,td{padding:9px 10px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:14px}
  th{color:#c7d0ff;text-align:left}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .tag{padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:#9bb8ff;background:#0e1630}
  .status{padding:8px 12px;border-radius:10px;margin-bottom:10px}
  .status.ok{background:#0b3a1f;color:#b9ffd5;border:1px solid #135d36}
  .status.warn{background:#3a1118;color:#ffd0d6;border:1px solid #6a1a28}

  footer{padding:16px;color:#9aa6c7;text-align:center}
</style>
</head>
<body>
  <header>
    <h1>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ</h1>
    <span class="flag" id="countryBadge">KR</span>
    <div class="tag" id="firebaseState">Firebase ì—°ê²° í™•ì¸ ì¤‘â€¦</div>
  </header>

  <main>
    <!-- ì™¼ìª½: ê²Œì„ -->
    <section class="card" id="gameCard">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="row" style="gap:6px">
          <strong>AD â€”</strong><span style="color:#9aa6c7">ì—¬ê¸°ì— ë°°ë„ˆ/ìŠ¤í¬ë¦½íŠ¸</span>
        </div>
      </div>

      <canvas id="board" width="300" height="600" tabindex="0" aria-label="Tetris board"></canvas>

      <!-- ê²Œì„ ì‹œì‘/ì¬ì‹œì‘ íŒì—… -->
      <div id="startOverlay" class="overlay open" aria-modal="true" role="dialog">
        <div class="overlay-card">
          <h3>ì¬ì‹œì‘ / Restart</h3>
          <p class="hint">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</p>
          <div class="field">
            <input id="nickname" type="text" minlength="2" maxlength="16" placeholder="ë‹‰ë„¤ì„ / Nickname (2ì ì´ìƒ)" autocomplete="off"/>
          </div>
          <button id="startBtn" type="button" class="btn-primary">ì‹œì‘</button>
          <div class="controls">ì¡°ì‘í‚¤: â† â†’ ì´ë™ Â· â†‘ íšŒì „ Â· â†“ ì†Œí”„íŠ¸ë“œë¡­ Â· Space í•˜ë“œë“œë¡­</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div>ì ìˆ˜ / Score <b id="score">0</b>ã€€ë¼ì¸ / Lines <b id="lines">0</b>ã€€ë ˆë²¨ / Level <b id="level">1</b></div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ë¦¬ë”ë³´ë“œ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ë¦¬ë”ë³´ë“œ / Leaderboard</h3>
        <div class="toolbar">
          <button class="btn" data-range="all"   id="btnAll">ALL</button>
          <button class="btn" data-range="week"  id="btnWeek">This Week</button>
          <button class="btn" data-range="month" id="btnMonth">This Month</button>
          <span style="width:10px"></span>
          <button class="btn" data-country="ALL" id="btnCountryAll">ALL</button>
          <button class="btn" data-country="KR"  id="btnCountryKR">KR</button>
        </div>
      </div>

      <div id="statusBar" class="status warn">Firebase ë¯¸ì„¤ì • ìƒíƒœì…ë‹ˆë‹¤.</div>
      <div class="status ok" id="saveToast" style="display:none">ì ìˆ˜ ì €ì¥ ì™„ë£Œ / Saved</div>

      <div style="width:100%;overflow:auto;max-height:62vh">
        <table>
          <thead><tr><th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>êµìœ¡/í”„ë¡œí† íƒ€ì…ìš© ë°ëª¨. ìš´ì˜ ì „ ì„œë²„ ê²€ì¦/ë³´ì•ˆ ê·œì¹™ ê°•í™” í•„ìš”.</footer>

  <!-- Firebase v9 compat CDN (ê°„ë‹¨ í†µí•©ì„ ìœ„í•´ compat ì‚¬ìš©) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  /***********************
   * 1) í™˜ê²½ì„¤ì •
   ***********************/
  // ğŸ”§ Cloudflare Worker êµ­ê°€ ê°ì§€ ì—”ë“œí¬ì¸íŠ¸ (ë‹¹ì‹  ì£¼ì†Œë¡œ êµì²´)
  const COUNTRY_API = 'https://tetris.kklstar2.workers.dev'; // â† ì˜ˆì‹œ: ë°°í¬í•œ ì›Œì»¤ ì£¼ì†Œ

  // ğŸ”§ Firebase í”„ë¡œì íŠ¸ ì„¤ì • (ì•ì„œ ì£¼ì‹  ê°’ìœ¼ë¡œ ì±„ì›€)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAHQng1yYRaIgSIMOHEJvKcKkUGjUQWkP0",
    authDomain: "grit-championship-v02.firebaseapp.com",
    databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
    projectId: "grit-championship-v02",
    storageBucket: "grit-championship-v02.firebasestorage.app",
    messagingSenderId: "644513888198",
    appId: "1:644513888198:web:baa0728174614bb68124c7",
    measurementId: "G-F8JGH16CR6"
  };

  let app, db, RTDB_ENABLED=false;
  let country = 'KR';
  let nickname = '';

  const countryBadge  = document.getElementById('countryBadge');
  const firebaseState = document.getElementById('firebaseState');
  const statusBar     = document.getElementById('statusBar');
  const saveToast     = document.getElementById('saveToast');

  // êµ­ê°€ ê°ì§€ (Cloudflare Worker)
  async function detectCountry(){
    try{
      const r = await fetch(COUNTRY_API,{mode:'cors'});
      const j = await r.json();
      country = (j.country || 'KR').toUpperCase();
    }catch(e){ country = 'KR'; }
    countryBadge.textContent = country;
  }

  // Firebase ì—°ê²°
  function connectFirebase(){
    try{
      app = firebase.initializeApp(FIREBASE_CONFIG);
      db  = firebase.database();
      RTDB_ENABLED = true;
      firebaseState.textContent = 'Firebase ì—°ê²° OK / Connected â€” ì ìˆ˜ ì—…ë¡œë“œ ê°€ëŠ¥';
      firebaseState.style.background = '#10391f';
      firebaseState.style.color = '#bffad5';
      statusBar.className='status ok';
      statusBar.textContent='ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (Firebase RTDB)';
    }catch(e){
      RTDB_ENABLED=false;
      firebaseState.textContent = 'Firebase ì—°ê²° ì‹¤íŒ¨';
      statusBar.className='status warn';
      statusBar.textContent='Firebase ë¯¸ì„¤ì • ìƒíƒœì…ë‹ˆë‹¤.';
    }
  }

  /***********************
   * 2) í…ŒíŠ¸ë¦¬ìŠ¤ (ê°„ë‹¨ êµ¬í˜„)
   ***********************/
  const W=10,H=20;             // ë³´ë“œ
  const S=30;                  // ì…€ í¬ê¸°
  const canvas = document.getElementById('board');
  const ctx = canvas.getContext('2d');

  let grid, cur, x,y,rot, score=0, lines=0, level=1, dropTI=null, dropDelay=800;
  let rngBag=[], lastI=0;      // Iì¡°ê° ë³´ì¥ ë¡œì§
  const scoreEl=document.getElementById('score');
  const linesEl=document.getElementById('lines');
  const levelEl=document.getElementById('level');

  const SHAPES = {
    I:[[1,1,1,1]],
    O:[[1,1],[1,1]],
    T:[[1,1,1],[0,1,0]],
    S:[[0,1,1],[1,1,0]],
    Z:[[1,1,0],[0,1,1]],
    J:[[1,0,0],[1,1,1]],
    L:[[0,0,1],[1,1,1]],
  };
  const COLORS = {I:'#53e3ff',O:'#ffd86b',T:'#b984ff',S:'#66ffaa',Z:'#ff6f82',J:'#7fb0ff',L:'#ffb36b'};

  function emptyGrid(){ grid=Array.from({length:H},()=>Array(W).fill(0)); }
  function drawCell(px,py,color){ ctx.fillStyle=color; ctx.fillRect(px*S,py*S,S-1,S-1); }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // ìŠ¤íƒ
    for(let r=0;r<H;r++)for(let c=0;c<W;c++){
      if(grid[r][c]) drawCell(c,r,grid[r][c]);
    }
    // í˜„ì¬ ë¸”ëŸ­
    if(cur) for(let r=0;r<cur.length;r++)for(let c=0;c<cur[0].length;c++){
      if(cur[r][c]) drawCell(x+c,y+r,COLORS[type]);
    }
  }
  function rotate(mat){
    const R=mat.length,C=mat[0].length;
    const out=Array.from({length:C},()=>Array(R).fill(0));
    for(let r=0;r<R;r++)for(let c=0;c<C;c++) out[c][R-1-r]=mat[r][c];
    return out;
  }
  function collide(nx,ny,nm){
    for(let r=0;r<nm.length;r++)for(let c=0;c<nm[0].length;c++){
      if(!nm[r][c]) continue;
      const yy=ny+r,xx=nx+c;
      if(xx<0||xx>=W||yy>=H) return true;
      if(yy>=0 && grid[yy][xx]) return true;
    }
    return false;
  }
  let type='I';
  function nextPiece(){
    // 7-bag + I ë¹ˆë„ ì¦ê°€ + 12íšŒ ì´ë‚´ I ë³´ì¥
    if(rngBag.length===0){
      rngBag=['I','I','O','T','S','Z','J','L']; // I 2ê°œ ë„£ì–´ ë¹ˆë„â†‘
      // ì„ê¸°
      for(let i=rngBag.length-1;i>0;i--){
        const j=(Math.random()* (i+1))|0; [rngBag[i],rngBag[j]]=[rngBag[j],rngBag[i]];
      }
    }
    if(lastI>=11){ type='I'; lastI=0; }
    else { type = rngBag.pop(); lastI += (type==='I'?0:1); }
    cur = SHAPES[type].map(row=>row.slice());
    x = ((W - cur[0].length)/2)|0; y=-1; rot=0;
    if(collide(x,y,cur)){ gameOver(); return false; }
    return true;
  }
  function merge(){
    for(let r=0;r<cur.length;r++)for(let c=0;c<cur[0].length;c++){
      if(cur[r][c]){
        const yy=y+r,xx=x+c; if(yy>=0) grid[yy][xx]=COLORS[type];
      }
    }
  }
  function clearLines(){
    let cleared=0;
    for(let r=H-1;r>=0;){
      if(grid[r].every(v=>v)){ grid.splice(r,1); grid.unshift(Array(W).fill(0)); cleared++; }
      else r--;
    }
    if(cleared){
      score += [0,100,300,500,800][cleared] * level;
      lines += cleared;
      if(lines>=level*10){ level++; dropDelay=Math.max(120, dropDelay-60); restartDrop(); }
      updateHUD();
    }
  }
  function updateHUD(){
    scoreEl.textContent=score; linesEl.textContent=lines; levelEl.textContent=level;
  }
  function stepDown(){
    if(!collide(x,y+1,cur)) y++;
    else{
      merge(); clearLines();
      nextPiece();
    }
    draw();
  }
  function restartDrop(){
    if(dropTI) cancelAnimationFrame(dropTI);
    // ê°„ë‹¨í•œ íƒ€ì´ë¨¸
    let last=performance.now();
    function loop(now){
      if(now-last>=dropDelay){ stepDown(); last=now; }
      dropTI = requestAnimationFrame(loop);
    }
    dropTI = requestAnimationFrame(loop);
  }

  // ì…ë ¥
  window.addEventListener('keydown',e=>{
    if(!cur) return;
    if(e.key==='ArrowLeft' && !collide(x-1,y,cur)){ x--; draw(); }
    if(e.key==='ArrowRight'&& !collide(x+1,y,cur)){ x++; draw(); }
    if(e.key==='ArrowDown'){ stepDown(); }
    if(e.key==='ArrowUp'){
      const nm=rotate(cur);
      if(!collide(x,y,nm)) { cur=nm; draw(); }
    }
    if(e.code==='Space'){ // í•˜ë“œë“œë
      while(!collide(x,y+1,cur)) y++;
      stepDown();
    }
  });

  function resetGame(){
    emptyGrid(); score=0; lines=0; level=1; dropDelay=800; updateHUD();
    nextPiece(); draw(); restartDrop();
  }

  function gameOver(){
    cancelAnimationFrame(dropTI); dropTI=null;
    draw();
    // ì¤‘ì•™ GAME OVER í…ìŠ¤íŠ¸
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fff'; ctx.font='bold 32px ui-sans-serif';
    ctx.textAlign='center';
    ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
    ctx.font='14px ui-sans-serif';
    ctx.fillText('ë‹¤ì‹œ í•˜ë ¤ë©´ ì¬ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”', canvas.width/2, canvas.height/2 + 26);

    // ì ìˆ˜ ì €ì¥
    saveScore(score).then(()=>{
      saveToast.style.display='block';
      setTimeout(()=>saveToast.style.display='none', 1500);
      // ê²Œì„ ì¬ì‹œì‘ì€ ì‚¬ìš©ìê°€ íŒì—…ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•˜ë„ë¡
      openStartOverlay();
    });
  }

  /***********************
   * 3) ì‹œì‘ ì˜¤ë²„ë ˆì´
   ***********************/
  const overlayEl  = document.getElementById('startOverlay');
  const nicknameEl = document.getElementById('nickname');
  const startBtnEl = document.getElementById('startBtn');

  function openStartOverlay(){ overlayEl.classList.add('open'); setTimeout(()=>nicknameEl.focus(),0); }
  function closeStartOverlay(){ overlayEl.classList.remove('open'); }

  function validateNickname(n){ n=(n||'').trim(); return n.length>=2 && n.length<=16; }

  function startGame(){
    // ì‹¤ì œ ê²Œì„ ì‹œì‘
    resetGame();
    // í¬ì»¤ìŠ¤ë¥¼ ìº”ë²„ìŠ¤ë¡œ
    canvas.focus();
  }

  async function handleStartClick(){
    const n = nicknameEl.value.trim();
    if(!validateNickname(n)){
      alert('ë‹‰ë„¤ì„ì„ 2ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); nicknameEl.focus(); return;
    }
    nickname = n;
    localStorage.setItem('nickname', nickname);
    closeStartOverlay();
    startGame();
  }
  startBtnEl.addEventListener('click',handleStartClick);
  nicknameEl.addEventListener('keydown',e=>{ if(e.key==='Enter') handleStartClick(); });

  // ë‹‰ë„¤ì„ ë³µì›
  const savedNick = localStorage.getItem('nickname')||''; if(savedNick) nicknameEl.value=savedNick;

  /***********************
   * 4) ì ìˆ˜ ì €ì¥ + ë¦¬ë”ë³´ë“œ
   ***********************/
  const tbody = document.getElementById('tbody');
  let range='all';         // all/week/month
  let countryFilter='ALL'; // ALL or KR

  document.getElementById('btnAll').onclick   = ()=>{ range='all';   refreshBoard(); };
  document.getElementById('btnWeek').onclick  = ()=>{ range='week';  refreshBoard(); };
  document.getElementById('btnMonth').onclick = ()=>{ range='month'; refreshBoard(); };
  document.getElementById('btnCountryAll').onclick=()=>{ countryFilter='ALL'; refreshBoard(); };
  document.getElementById('btnCountryKR').onclick =()=>{ countryFilter='KR';  refreshBoard(); };

  function weekStart(ts){ const d=new Date(ts); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d.getTime(); }
  function monthStart(ts){ const d=new Date(ts); d.setDate(1); d.setHours(0,0,0,0); return d.getTime(); }

  async function saveScore(sc){
    if(!RTDB_ENABLED) return;
    try{
      const ref = db.ref('scores_v1').push();
      await ref.set({nickname:nickname||'Guest',country,score:sc,ts:Date.now()});
    }catch(e){ console.warn('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨',e); }
  }

  function refreshBoard(){
    if(!RTDB_ENABLED){ tbody.innerHTML=''; return; }
    const ref = db.ref('scores_v1').orderByChild('score').limitToLast(100);
    ref.off();
    ref.on('value',snap=>{
      const rows=[];
      snap.forEach(child=>{ rows.push(child.val()); });
      // ì •ë ¬ (score desc)
      rows.sort((a,b)=>b.score-a.score);

      const now=Date.now();
      const ws=weekStart(now), ms=monthStart(now);

      const filtered = rows.filter(r=>{
        if(countryFilter!=='ALL' && (r.country||'KR').toUpperCase()!==countryFilter) return false;
        if(range==='week' && r.ts<ws) return false;
        if(range==='month'&& r.ts<ms) return false;
        return true;
      }).slice(0,50);

      tbody.innerHTML = filtered.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(r.nickname||'Guest')}</td>
          <td>${(r.country||'KR').toUpperCase()}</td>
          <td>${r.score||0}</td>
        </tr>
      `).join('');
    });
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  /***********************
   * 5) ë¶€íŠ¸ìŠ¤íŠ¸ë©
   ***********************/
  (async function boot(){
    await detectCountry();
    connectFirebase();
    refreshBoard();
    openStartOverlay(); // ì²« ì§„ì… íŒì—…
    emptyGrid(); draw(); // ë¹ˆ ë³´ë“œ í‘œì‹œ
  })();
  </script>
</body>
</html>
