<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ â€” Tetris</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… ê¸°ì¡´ ë””ìì¸/í°íŠ¸/ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”.
       ì•„ë˜ CSSëŠ” ì˜¤ë²„ë ˆì´ íŒì—…ê³¼ í…Œì´ë¸”ë§Œ ìµœì†Œí•œìœ¼ë¡œ ìŠ¤íƒ€ì¼ë§(ë‹¤í¬í†¤) í•©ë‹ˆë‹¤. -->
  <style>
    /* ìµœì†Œ ì˜¤ë²„ë ˆì´: ê¸°ì¡´ ë ˆì´ì•„ì›ƒì„ ê±´ë“œë¦¬ì§€ ì•ŠìŒ */
    #gc-overlay {
      position: fixed; inset: 0; display: none;
      background: rgba(0,0,0,.48);
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    #gc-dialog {
      width: min(92vw, 360px);
      background: #111a22;
      color: #dbe8ff;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.08);
    }
    #gc-dialog h3 { margin: 4px 0 14px; font-size: 18px; font-weight: 700; }
    #gc-dialog .row { display: grid; gap: 10px; margin: 10px 0 4px; }
    #gc-nickname {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      background: #0f1720; border: 1px solid rgba(255,255,255,.12);
      color: #e8f0ff; outline: none;
    }
    #gc-start {
      width: 100%; padding: 11px 12px; border-radius: 10px; cursor: pointer;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg,#26d07c,#18b46a);
      color: #00140b; font-weight: 800; letter-spacing: .2px;
    }
    #gc-msg { font-size: 12px; color: #70ffa8d0; margin-top: 8px; min-height: 14px; }

    /* ë¦¬ë”ë³´ë“œ í‘œ(ê¸°ì¡´ í‘œê°€ ìˆìœ¼ë©´ ì´ ìŠ¤íƒ€ì¼ì´ ì‚´ì§ë§Œ ì–¹í™ë‹ˆë‹¤) */
    table.gc-board { width: 100%; border-collapse: collapse; font-size: 14px; color: #cfe8ff; }
    table.gc-board thead th {
      text-align: left; font-weight: 700; color: #88bfff; padding: 8px 10px;
      background: rgba(255,255,255,.06); border-bottom: 1px solid rgba(255,255,255,.07);
    }
    table.gc-board tbody td { padding: 8px 10px; border-bottom: 1px dashed rgba(255,255,255,.06); }
    .gc-badge { display:inline-flex; align-items:center; gap:6px; }
    .gc-flag { width: 18px; height: 12px; border-radius: 2px; object-fit: cover; border: .5px solid rgba(255,255,255,.25); }
    .gc-pill { display:inline-block; padding:4px 10px; border-radius: 999px; font-size:12px; }
    .gc-pill.live { background:#063; color:#81ffbd; border:1px solid #0a5; }
    .gc-pill.saved{ background:#11213a; color:#9bd2ff; border:1px solid #244a86; }
  </style>
</head>
<body>

  <!-- â–½â–½â–½ ê¸°ì¡´ ê²Œì„ ë³´ë“œ / ì ìˆ˜íŒ / í•„í„° / ë¦¬ë”ë³´ë“œ ë“± â€œê¸°ì¡´ ë§ˆí¬ì—…â€ì€ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš” â–½â–½â–½ -->
  <!--
    - ì ìˆ˜ ì¶œë ¥ span:  id="ui-score"
    - ë‹‰ë„¤ì„ ì…ë ¥ ì¸í’‹ì´ ê¸°ì¡´ì— ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ì•„ë˜ ì˜¤ë²„ë ˆì´ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.
    - ë¦¬ë”ë³´ë“œ tbody: id="leaderboard-body"  (ì—†ìœ¼ë©´ ì•„ë˜ì—ì„œ ìë™ ìƒì„±)
    - í•„í„° ë²„íŠ¼(ì„ íƒ): id="flt-all" / id="flt-week" / id="flt-month" / id="flt-kr" / id="flt-allCountry"
  -->

  <!-- âœ… ë¦¬ë”ë³´ë“œ í…Œì´ë¸”ì´ ì—†ë‹¤ë©´ ì•„ë˜ë¥¼ í•œ ë²ˆë§Œ ë§Œë“¤ì–´ ë‘¡ë‹ˆë‹¤ -->
  <section id="gc-leaderboard-host">
    <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
      <span class="gc-pill live">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (Firebase RTDB)</span>
      <span id="gc-info" class="gc-pill saved" style="display:none;">ì ìˆ˜ ì €ì¥ ì™„ë£Œ</span>
      <!-- (í•„ìš” ì‹œ) í•„í„° ë²„íŠ¼ì´ ê¸°ì¡´ì— ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì“°ì…ë‹ˆë‹¤ -->
    </div>
    <table class="gc-board">
      <thead>
        <tr>
          <th>#</th>
          <th>ë‹‰ë„¤ì„ / Nickname</th>
          <th>êµ­ê°€ / Country</th>
          <th>ì ìˆ˜ / Score</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </section>

  <!-- âœ… Game Over / ì‹œì‘ ì˜¤ë²„ë ˆì´ (ë””ìì¸ ìµœì†Œ ë³€ê²½) -->
  <div id="gc-overlay" role="dialog" aria-modal="true">
    <div id="gc-dialog">
      <h3 id="gc-title">Game Over</h3>
      <div class="row">
        <input id="gc-nickname" type="text" placeholder="ë‹‰ë„¤ì„ / Nickname (2ì ì´ìƒ)" />
        <button id="gc-start">ì‹œì‘</button>
        <div id="gc-msg"></div>
      </div>
      <div style="font-size:12px; opacity:.7;">ì¡°ì‘: â† â†’ ì´ë™ Â· â†‘ íšŒì „ Â· â†“ ì†Œí”„íŠ¸ë“œë¡­ Â· Space í•˜ë“œë“œë¡­ (í´ë˜ì‹)</div>
    </div>
  </div>

  <!-- â–½â–½â–½ â–½â–½â–½ â–½â–½â–½  ì—¬ê¸°ê¹Œì§€ â€œê¸°ì¡´ í™”ë©´â€ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤ â–½â–½â–½ â–½â–½â–½ â–½â–½â–½ -->

  <script>
    /** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *  ê³µìš© ìœ í‹¸
     *  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function loadScriptOnce(src){
      return new Promise((resolve, reject)=>{
        if([...(document.scripts||[])].some(s=>s.src===src)) return resolve();
        const s=document.createElement('script'); s.src=src;
        s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }
    const pad2 = n => (n<10?'0':'')+n;
    const ymd = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const weekStart = (d=new Date())=>{
      const c=new Date(d); const day=(c.getDay()+6)%7; c.setDate(c.getDate()-day);
      c.setHours(0,0,0,0); return c;
    };
    const monthStart = (d=new Date())=>{
      const c=new Date(d.getFullYear(), d.getMonth(), 1); c.setHours(0,0,0,0); return c;
    };

    /** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *  Firebase ì—°ê²° (ë””ìì¸/ê²Œì„ ë¡œì§ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
     *  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function ensureFirebaseReady(){
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js');

      /* ğŸ”½ğŸ”½ ë³¸ì¸ ì½˜ì†”ì˜ ê°’ìœ¼ë¡œ ì´ë¯¸ êµì²´í•´ ë“œë ¸ìŠµë‹ˆë‹¤ (ìš”ì²­í•˜ì‹  ê°’) */
      const firebaseConfig = {
        apiKey: "AIzaSyAHQngy1vRalgSIMOHEJvKcKkUGkUQwKPQ",
        authDomain: "grit-championship-v02.firebaseapp.com",
        databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
        projectId: "grit-championship-v02",
        storageBucket: "grit-championship-v02.appspot.com",
        messagingSenderId: "644513888198",
        appId: "1:644513888198:web:baa0728174614bb68124c7",
        measurementId: "G-F83JH16CR6"
      };

      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      return firebase.database();
    }

    let DB=null;                 // RTDB í•¸ë“¤
    let ACTIVE_COUNTRY='ALL';    // KR / ALL
    let ACTIVE_RANGE='ALL';      // ALL / WEEK / MONTH
    let COUNTRY_CODE='KR';       // ê¸°ë³¸ KR (Cloudflare Worker ì—°ë™ ì‹œ ìë™ê°ì§€ ë°”ì¸ë”© ê°€ëŠ¥)
    let saving=false;

    (async()=>{
      try{
        DB = await ensureFirebaseReady();
        console.log('âœ… Firebase ì—°ê²° OK');

        // í—¬ìŠ¤ ì²´í¬(ì„ íƒ)
        await DB.ref('healthcheck').set({ ping: Date.now() });
        const snap = await DB.ref('healthcheck').get();
        console.log('RTDB write/read OK:', snap.val());

        subscribeRealtime();   // ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ
        wireFilters();         // í•„í„° ë²„íŠ¼ ì—°ê²°(ì¡´ì¬ ì‹œ)
        wirePopup();           // íŒì—… ë²„íŠ¼ ì—°ê²°
        wrapEndGame();         // endGame ë˜í•‘(ê¸°ì¡´ ë¡œì§ ë³´ì¡´)
      }catch(e){
        console.error('âŒ Firebase ì—°ê²° ì‹¤íŒ¨:', e);
        const info=document.getElementById('gc-info');
        if(info){ info.textContent='ë­í‚¹ ë¹„í™œì„± â€” Firebase ë¯¸ì—°ê²°'; info.style.display='inline-block'; }
      }
    })();

    /** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *  ë¦¬ë”ë³´ë“œ: ì‹¤ì‹œê°„ êµ¬ë… + ë Œë”
     *  êµ¬ì¡°: /scores/YYYY-MM-DD/<nick> = { score, country, ts }
     *  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function subscribeRealtime(){
      if(!DB) return;
      DB.ref('scores').on('value', snap=>{
        const rows=[];
        snap.forEach(dateSnap=>{
          const dateKey = dateSnap.key;       // YYYY-MM-DD
          const date = new Date(dateKey+'T00:00:00');
          dateSnap.forEach(userSnap=>{
            const v=userSnap.val()||{};
            if(typeof v.score==='number'){
              rows.push({ date, nick: userSnap.key, score: v.score, country: v.country||'KR', ts: v.ts||0 });
            }
          });
        });

        // í•„í„°ë§
        const now=new Date();
        let from = new Date(0);
        if(ACTIVE_RANGE==='WEEK') from = weekStart(now);
        else if(ACTIVE_RANGE==='MONTH') from = monthStart(now);
        const filtered = rows.filter(r => r.date >= from)
                             .filter(r => ACTIVE_COUNTRY==='ALL' ? true : r.country===ACTIVE_COUNTRY);

        // ì •ë ¬ & ìƒìœ„ 50
        filtered.sort((a,b)=> b.score - a.score || a.ts - b.ts);
        renderBoard(filtered.slice(0,50));
      });
    }

    function renderBoard(list){
      // tbody í™•ë³´ (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
      let tbody = document.getElementById('leaderboard-body');
      if(!tbody){
        const host=document.getElementById('gc-leaderboard-host');
        if(!host) return;
        const table=host.querySelector('table.gc-board')||document.createElement('table');
        if(!table.classList.contains('gc-board')){
          table.className='gc-board'; table.innerHTML = `
            <thead><tr>
              <th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th>
            </tr></thead><tbody id="leaderboard-body"></tbody>`;
          host.appendChild(table);
        }
        tbody = document.getElementById('leaderboard-body');
      }

      tbody.innerHTML='';
      list.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        const flag = `<img class="gc-flag" src="https://flagcdn.com/w20/${(r.country||'KR').toLowerCase()}.png" alt="">`;
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.nick}</td>
          <td><span class="gc-badge">${flag}<span>${r.country}</span></span></td>
          <td>${r.score.toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    }

    /** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *  Game Over ì €ì¥: ê¸°ì¡´ endGameë¥¼ ë˜í•‘(ì›ë³¸ ìœ ì§€)
     *  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function wrapEndGame(){
      const original = window.endGame || function(){};
      window.endGame = async function(){
        try{
          await saveScore();   // ì €ì¥ ì‹œë„
        }catch(e){ console.warn('saveScore skipped:', e); }
        original();            // ì›ë³¸ ë™ì‘(ì‚¬ìš´ë“œ/ì• ë‹ˆ/ë¡œì§) ê·¸ëŒ€ë¡œ
        openPopup('Game Over'); // íŒì—… ì—´ê¸° (ë‹‰ë„¤ì„ ì…ë ¥/ì¬ì‹œì‘)
      };
    }

    async function saveScore(){
      if(saving || !DB) return;
      const score = parseInt((document.getElementById('ui-score')?.textContent||'0'),10) || 0;
      const nickInput = document.getElementById('gc-nickname');
      const nickname = (nickInput?.value || 'Guest').trim().replace(/[.#$\[\]]/g,'_');
      if(!nickname) return;

      saving=true;
      try{
        const dateKey = ymd(new Date());  // YYYY-MM-DD
        const ref = DB.ref(`scores/${dateKey}/${nickname}`);

        // ì´ë¯¸ ì¡´ì¬í•˜ë©´(ê·œì¹™ìƒ ë®ì–´ì“°ê¸° ê¸ˆì§€), set()ì€ ê±°ì ˆ â†’ catchë¡œ ë¹ ì§.
        await ref.set({ score, country: COUNTRY_CODE||'KR', ts: Date.now() });

        const info=document.getElementById('gc-info');
        if(info){ info.textContent='ì ìˆ˜ ì €ì¥ ì™„ë£Œ / Saved'; info.style.display='inline-block'; }
      }catch(e){
        console.warn('RTDB set skipped(or denied by rule).', e?.message||e);
      }finally{ saving=false; }
    }

    /** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     *  ì˜¤ë²„ë ˆì´ / í•„í„°
     *  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function wirePopup(){
      const overlay=document.getElementById('gc-overlay');
      const btn=document.getElementById('gc-start');
      if(btn) btn.addEventListener('click', ()=>{
        const v=(document.getElementById('gc-nickname').value||'').trim();
        if(v.length<2){ document.getElementById('gc-msg').textContent='ë‹‰ë„¤ì„ 2ì ì´ìƒ ì…ë ¥'; return; }
        document.getElementById('gc-msg').textContent='';
        overlay.style.display='none';
        // ì‹¤ì œ ê²Œì„ ì¬ì‹œì‘ íŠ¸ë¦¬ê±°ê°€ ë”°ë¡œ ìˆìœ¼ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ì„¸ìš” (ì˜ˆ: startGame())
        // window.startGame && window.startGame();
      });
    }
    function openPopup(title='Game Over'){
      const o=document.getElementById('gc-overlay');
      const t=document.getElementById('gc-title');
      if(t) t.textContent=title;
      if(o) o.style.display='flex';
      // ê²Œì„ í‚¤ì…ë ¥ ì¤‘ë³µ ë°©ì§€ í•„ìš” ì‹œ ì—¬ê¸°ì„œ ì ê¸ˆ(ì„ íƒ)
    }

    function wireFilters(){
      // ì£¼ê°„
      const w=document.getElementById('flt-week');
      if(w) w.addEventListener('click', ()=>{ ACTIVE_RANGE='WEEK'; subscribeRealtime(); });

      // ì›”ê°„
      const m=document.getElementById('flt-month');
      if(m) m.addEventListener('click', ()=>{ ACTIVE_RANGE='MONTH'; subscribeRealtime(); });

      // ì „ì²´(ê¸°ê°„)
      const a=document.getElementById('flt-all');
      if(a) a.addEventListener('click', ()=>{ ACTIVE_RANGE='ALL'; subscribeRealtime(); });

      // êµ­ê°€ KR
      const kr=document.getElementById('flt-kr');
      if(kr) kr.addEventListener('click', ()=>{ ACTIVE_COUNTRY='KR'; subscribeRealtime(); });

      // êµ­ê°€ ALL
      const al=document.getElementById('flt-allCountry');
      if(al) al.addEventListener('click', ()=>{ ACTIVE_COUNTRY='ALL'; subscribeRealtime(); });
    }
  </script>

  <!-- â–½â–½â–½ â–½â–½â–½ â–½â–½â–½ â–½â–½â–½
    âœ… ì´ ì•„ë˜ì— â€œê¸°ì¡´ ê²Œì„ ìŠ¤í¬ë¦½íŠ¸(í…ŒíŠ¸ë¦¬ìŠ¤ ì—”ì§„)â€ê°€ ì´ë¯¸ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”.
       ìœ„ ì½”ë“œê°€ endGame()ë§Œ ë˜í•‘í•´ì„œ ì €ì¥/íŒì—…ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
       (startGame ë“± ê¸°ì¡´ í•¨ìˆ˜ëª…/ë¡œì§ì€ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
  â–½â–½â–½ â–½â–½â–½ â–½â–½â–½ â–½â–½â–½ -->

</body>
</html>
