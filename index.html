<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>천하제일 근성 대회 - 테트리스</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ✅ 게임 디자인(CSS)은 여기에 — (이미 적용한 블록 색상/폰트/레이아웃 그대로 두세요) */
  </style>
</head>
<body>
  <!-- ✅ 게임 보드 -->
  <div id="game">
    <canvas id="board" width="240" height="480"></canvas>
    <div id="ui">
      점수 <span id="ui-score">0</span> |
      라인 <span id="ui-lines">0</span> |
      레벨 <span id="ui-level">1</span>
    </div>
  </div>

  <!-- ✅ 리더보드 -->
  <div id="leaderboard">
    <h3>리더보드</h3>
    <table>
      <thead>
        <tr><th>#</th><th>닉네임 / Nickname</th><th>국가 / Country</th><th>점수 / Score</th></tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <!-- ✅ 닉네임 입력/팝업 -->
  <div id="popup" style="display:none;">
    <h2 id="popup-title">Game Over</h2>
    <p>닉네임을 입력하고 시작하세요.</p>
    <input id="nickname" type="text" placeholder="닉네임" />
    <button id="startBtn">시작</button>
  </div>

  <!-- ✅ 게임 로직 (테트리스 엔진 + 키 입력 + 블록 색상 등) -->
  <script>
    // 👉 여기에는 기존 테트리스 게임 코드 전부 들어갑니다
    // (render(), drawBoard(), handleKey(), drop(), endGame(), etc.)
  </script>

  <!-- ✅ Firebase 랭킹 연동 블록 -->
  <script>
    async function ensureFirebaseReady(){
      // Firebase SDK 불러오기
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js');

      // Firebase 설정값 (Firebase 콘솔에서 복사한 것)
      const firebaseConfig = {
        apiKey: "AIzaSyAHqngy1vRalgSIMOHEJvKcKkUGkUQwKPQ",
        authDomain: "grit-championship-v02.firebaseapp.com",
        databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
        projectId: "grit-championship-v02",
        storageBucket: "grit-championship-v02.appspot.com",
        messagingSenderId: "644513888198",
        appId: "1:644513888198:web:baa0728174614bb68124c7",
        measurementId: "G-F83JH16CR6"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      return firebase.database();
    }

    // Firebase DB 핸들러 전역 준비
    let db;
    (async () => {
      db = await ensureFirebaseReady();
      console.log("✅ Firebase 연결 성공");
    })();

    // Game Over 시 DB에 점수 저장
    window.endGame = async function() {
      const nick = document.getElementById("nickname").value || "Guest";
      const score = parseInt(document.getElementById("ui-score").textContent || "0", 10);
      const country = "KR"; // 👈 Cloudflare Worker API 연동 시 실제 국가코드 반영 가능

      try {
        const today = new Date().toISOString().slice(0,10);
        await db.ref(`scores/${today}/${nick}`).set({
          score: score,
          country: country,
          ts: Date.now()
        });
        console.log("✅ 점수 저장 완료");
      } catch(e) {
        console.error("❌ 점수 저장 실패:", e);
      }

      // 팝업 열기
      document.getElementById("popup").style.display = "block";
    };
  </script>
</body>
</html>
