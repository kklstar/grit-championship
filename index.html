<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì²œí•˜ì œì¼ ê·¼ì„± ëŒ€íšŒ - í…ŒíŠ¸ë¦¬ìŠ¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* âœ… ê²Œì„ ë””ìì¸(CSS)ì€ ì—¬ê¸°ì— â€” (ì´ë¯¸ ì ìš©í•œ ë¸”ë¡ ìƒ‰ìƒ/í°íŠ¸/ë ˆì´ì•„ì›ƒ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”) */
  </style>
</head>
<body>
  <!-- âœ… ê²Œì„ ë³´ë“œ -->
  <div id="game">
    <canvas id="board" width="240" height="480"></canvas>
    <div id="ui">
      ì ìˆ˜ <span id="ui-score">0</span> |
      ë¼ì¸ <span id="ui-lines">0</span> |
      ë ˆë²¨ <span id="ui-level">1</span>
    </div>
  </div>

  <!-- âœ… ë¦¬ë”ë³´ë“œ -->
  <div id="leaderboard">
    <h3>ë¦¬ë”ë³´ë“œ</h3>
    <table>
      <thead>
        <tr><th>#</th><th>ë‹‰ë„¤ì„ / Nickname</th><th>êµ­ê°€ / Country</th><th>ì ìˆ˜ / Score</th></tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <!-- âœ… ë‹‰ë„¤ì„ ì…ë ¥/íŒì—… -->
  <div id="popup" style="display:none;">
    <h2 id="popup-title">Game Over</h2>
    <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</p>
    <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„" />
    <button id="startBtn">ì‹œì‘</button>
  </div>

  <!-- âœ… ê²Œì„ ë¡œì§ (í…ŒíŠ¸ë¦¬ìŠ¤ ì—”ì§„ + í‚¤ ì…ë ¥ + ë¸”ë¡ ìƒ‰ìƒ ë“±) -->
  <script>
    // ğŸ‘‰ ì—¬ê¸°ì—ëŠ” ê¸°ì¡´ í…ŒíŠ¸ë¦¬ìŠ¤ ê²Œì„ ì½”ë“œ ì „ë¶€ ë“¤ì–´ê°‘ë‹ˆë‹¤
    // (render(), drawBoard(), handleKey(), drop(), endGame(), etc.)
  </script>

  <!-- âœ… Firebase ë­í‚¹ ì—°ë™ ë¸”ë¡ -->
  <script>
    async function ensureFirebaseReady(){
      // Firebase SDK ë¶ˆëŸ¬ì˜¤ê¸°
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
      await loadScriptOnce('https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js');

      // Firebase ì„¤ì •ê°’ (Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ê²ƒ)
      const firebaseConfig = {
        apiKey: "AIzaSyAHqngy1vRalgSIMOHEJvKcKkUGkUQwKPQ",
        authDomain: "grit-championship-v02.firebaseapp.com",
        databaseURL: "https://grit-championship-v02-default-rtdb.firebaseio.com",
        projectId: "grit-championship-v02",
        storageBucket: "grit-championship-v02.appspot.com",
        messagingSenderId: "644513888198",
        appId: "1:644513888198:web:baa0728174614bb68124c7",
        measurementId: "G-F83JH16CR6"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      return firebase.database();
    }

    // Firebase DB í•¸ë“¤ëŸ¬ ì „ì—­ ì¤€ë¹„
    let db;
    (async () => {
      db = await ensureFirebaseReady();
      console.log("âœ… Firebase ì—°ê²° ì„±ê³µ");
    })();

    // Game Over ì‹œ DBì— ì ìˆ˜ ì €ì¥
    window.endGame = async function() {
      const nick = document.getElementById("nickname").value || "Guest";
      const score = parseInt(document.getElementById("ui-score").textContent || "0", 10);
      const country = "KR"; // ğŸ‘ˆ Cloudflare Worker API ì—°ë™ ì‹œ ì‹¤ì œ êµ­ê°€ì½”ë“œ ë°˜ì˜ ê°€ëŠ¥

      try {
        const today = new Date().toISOString().slice(0,10);
        await db.ref(`scores/${today}/${nick}`).set({
          score: score,
          country: country,
          ts: Date.now()
        });
        console.log("âœ… ì ìˆ˜ ì €ì¥ ì™„ë£Œ");
      } catch(e) {
        console.error("âŒ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:", e);
      }

      // íŒì—… ì—´ê¸°
      document.getElementById("popup").style.display = "block";
    };
  </script>
</body>
</html>
